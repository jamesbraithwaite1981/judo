<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Close Plan</title>
	 <link rel="stylesheet" href="https://unpkg.com/mind-elixir/dist/mind-elixir.css">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<!-- Summernote CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/summernote-bs4.min.css" rel="stylesheet">
<!-- jsMind CSS -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
<link rel="shortcut icon" href="https://www.thirdera.com/hubfs/Thirdera_Favicon-01-1.png">


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <!-- Summernote JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/summernote-bs4.min.js"></script>
<!-- Popper.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>

<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
<!-- jsMind JavaScript library -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis-timeline-graph2d.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/mind-elixir@1.2.0/dist/MindElixir.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


 
   <style>
		#mainDiv {
            color: white; /* Make text color white */
            width: 100%;
			height: calc(100vh - 56.5px);

        }
body {
    position: relative;
    background-image: url('background.png');
    background-size: cover;
    background-attachment: fixed;
    background-repeat: no-repeat;
	  padding-bottom: 100px;
}

body::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.0); /* Black color with 20% opacity */
    z-index: -1;
}
.page-end-spacer {
    height: 0px; /* or more, as needed */
}
#backgroundContainer {
    position: fixed; /* or absolute, depending on your layout */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    z-index: -1; /* Ensure it stays behind the content */
}

		.row {
			min-height: 25%; /* Adjust the percentage based on your requirement */         
			/* align-items: center;  Center content vertically */
            justify-content: center; /* Center content horizontally */
			 border-bottom: 1px dashed rgba(255, 255, 255, 0.7); /* White dashed line with 50% transparency */

        }		
		.cardClear {
			background: none !important; /* Remove background */
			border: 1px solid white !important; /* Set a 1px solid white border */
			border-radius: 0.25rem !important; /* Rounded edges (default Bootstrap value for slight rounding) */
			width: 15%;
			align-items: center; /* Center content vertically */
            justify-content: center; /* Center content horizontally */
			margin-top: 10px;

		}
		.cardClear:hover {
			background-color: rgba(255, 255, 255, 0.1); /* Slight white fill on hover */
			cursor: pointer; /* Changes the cursor to indicate it's clickable */
		}
		.cardClear2 {
			background: none !important; /* Remove background */
			border: 1px solid white !important; /* Set a 1px solid white border */
			border-radius: 0.25rem !important; /* Rounded edges (default Bootstrap value for slight rounding) */
			width: 100%;
			 justify-content: center; /* Center content horizontally */
			 text-align: center;
		}
		.cardClear2:hover {
			background-color: rgba(255, 255, 255, 0.1); /* Slight white fill on hover */
			cursor: pointer; /* Changes the cursor to indicate it's clickable */
		}
		.horizontal-scroll {
			display: flex; /* Enable Flexbox */
			flex-direction: row; /* Arrange children in a horizontal row */
			overflow-x: auto; /* Enable horizontal scrolling */
			white-space: nowrap; /* Prevent wrapping to ensure horizontal layout */
			 height: 100%; /* Make sure the parent container fills the height of its parent */
			 overflow-y: hidden; /* Hides vertical overflow and scroll */
			align-items: center; /* Center content vertically */
		}
.project-column {
  min-height: 120px; /* Adjust as needed */
}
		.item {
			flex: 0 0 auto; /* Prevent items from growing or shrinking */
			margin-right: 10px; /* Optional: Adds spacing between items */
			overflow-wrap: break-word; /* Prevents text overflow by breaking long words */			
			height: 85%; /* Makes each item fill the height of the .horizontal-scroll container */
			white-space: normal; /* Allows text to wrap normally */
			overflow-y: hidden; /* Hide vertical overflow for each item */
			padding: 3px;
			align-items: center; /* Center content vertically */
			text-align: center;
			}
		.custom-header {
			background-color: white; /* White background */
			font-weight: bold; /* Bold text */
			color: #5f249f;
			padding: 3px;
			text-align: center;	
			 border-radius: 5px; 		
			 border-radius: 5px; 	
			height: 30px;
			margin-top:10px;
		}
		.clickMe:hover{
		cursor: pointer; /* Changes the cursor to indicate it's clickable */
		}
		
		/* For Webkit browsers */
		.horizontal-scroll::-webkit-scrollbar {
			height: 8px; /* Height of the scrollbar */
		}

		.horizontal-scroll::-webkit-scrollbar-track {
			background: #f1f1f1; /* Color of the track */
			border-radius: 4px; /* Roundness of the track */
		}

		.horizontal-scroll::-webkit-scrollbar-thumb {
			background: #663399; /* Color of the scrollbar thumb */
			border-radius: 4px; /* Roundness of the scrollbar thumb */
		}

		.horizontal-scroll::-webkit-scrollbar-thumb:hover {
			background: #555; /* Color of the scrollbar thumb on hover */
		}
/* For Webkit browsers */
::-webkit-scrollbar {
    width: 8px; /* Width of the vertical scrollbar */
}

::-webkit-scrollbar-track {
    background: #f1f1f1; /* Color of the track */
    border-radius: 4px; /* Roundness of the track */
}

::-webkit-scrollbar-thumb {
    background: #663399; /* Color of the scrollbar thumb */
    border-radius: 4px; /* Roundness of the scrollbar thumb */
}

::-webkit-scrollbar-thumb:hover {
    background: #555; /* Color of the scrollbar thumb on hover */
}
.sortable-placeholder {
    border: 1px dashed #333;
    background: #f7f7f7;
    height: 2em;
    /* Adjust as needed */
}






/* Default modal width */
#taskModal .modal-dialog {
    max-width: 75%;
}

/* Smaller screens: less than 1560 pixels */
@media (max-width: 1560px) {
    #taskModal .modal-dialog {
        max-width: 95%;
    }
}

		#taskModal .modal-content {
			min-height: 800px;
		}

		#projectTitle {
			font-weight: bold;
			margin-right: 20px;
		}

		.notes-input {
			display: none; /* Hides the textarea by default */
			width: 80%;
			height: 30em;
			margin-bottom: 20px;
		}
		.centeredElement {
			margin-left: auto;
			margin-right: auto;
			display: block; /* This is necessary for elements that are not block-level by default */
		}

	.ui-datepicker {
		z-index: 999999 !important;
	}
	.datepicker{ z-index:99999 !important; }

	.slim-table th {
	  padding: 5px 10px; /* Adjust padding as needed */
	  font-size: 14px; /* Optional: Adjust font size as needed */
	}

	/* Custom class for slim table rows */
	.slim-table td {
	  padding: 5px 10px; /* Adjust padding as needed */
	  font-size: 14px; /* Optional: Adjust font size as needed */
	}
	/* Initially hide the priority toggle */
	.priority-toggle {
	  visibility: hidden;
	  opacity: 0;
	  transition: visibility 0s, opacity 0.5s ease;
	}

	/* Show the toggle when hovering over the row */
	.task-row:hover .priority-toggle {
	  visibility: visible;
	  opacity: 1;
	  transition-delay: 0s;
	}

	/* Style for the cell containing the toggle, to align the toggle to the right */
	.priority-toggle-cell {
	  text-align: right;
	}
	.sortable-placeholder {
		border: 1px dashed #333;
		margin: 5px;
		padding: 5px;
		border-radius: 5px;
		background: #f7f7f7;
	}
/* Center align text in cells */
#contactsTable td, #contactsTable th {
    text-align: center;
    vertical-align: middle;
}
/* Remove background-color to allow dynamic setting */
.status-select {
    background-color: transparent; /* Or remove this line entirely */
    /* Other styles */
}

/* Contacts table container styles */
.contacts-table-container {
    max-height: 150px; /* Adjust this value as needed */
    overflow: hidden;
    transition: max-height 0.3s ease;
}

/* On hover, expand to show all rows */
.contacts-table-container:hover {
    max-height: 1000px; /* A large value to accommodate all rows */
    overflow: auto; /* Enable scrolling if content exceeds viewport */
}


.select-green {
  background-color: #b3e6b3 !important; /* Pastel green */
}

.select-red {
  background-color: #f4cccc !important; /* Pastel red */
}


/* Target both elements using their IDs */
#allTasksList,
#focusTasksList {
  position: relative;
  background: url('background.png') no-repeat center center;
  background-size: cover; /* Stretches the image to fit the div */
  
  /* Semi-transparent overlay effect */
  background-color: rgba(229, 229, 229, 0.8); /* Light grey with 80% opacity */
  border-radius: 10px; /* Rounded corners */
  padding: 10px;

  /* Ensure content inside remains readable */
  backdrop-filter: blur(5px); /* Optional: Blurs background slightly */
}




.modal-fullscreen {
  width: 100vw;       /* Take full viewport width */
  max-width: 100%;     /* Ensure no max-width constraints */
  margin: 0;           /* Remove default margins */
  padding: 0;          /* Remove any default padding */
}

.modal-fullscreen .modal-content {
  height: 100vh;       /* Full viewport height as well (optional) */
  border-radius: 0;    /* Remove rounded corners if desired */
}

/* Target editable cells in #newLogoTable only */
#newLogoTable td.editable-cell {
  white-space: pre-wrap;
  word-wrap: break-word; /* or overflow-wrap: break-word; */
}



/* Optional: Hide the scrollbar when not needed */
.contacts-table-container::-webkit-scrollbar {
    width: 0px;
    background: transparent;
}

.contacts-table-container {
    -ms-overflow-style: none;  /* Internet Explorer 10+ */
    scrollbar-width: none;     /* Firefox */
}

.contacts-table-container:hover::-webkit-scrollbar {
    width: 6px;
}

.contacts-table-container:hover {
    -ms-overflow-style: auto;
    scrollbar-width: auto;
}

/* Set the maximum width of the Status column */
#contactsTable th.status-header,
#contactsTable td.status-cell {
    width: 60px;
    max-width: 60px;
    padding: 0; /* Remove padding to save space */
}

/* Adjust the select element to fit within the cell */
.status-cell .status-select {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    font-size: 12px; /* Adjust font size to fit */
    border: none;
    outline: none;
    -webkit-appearance: none; /* Remove default styling */
    -moz-appearance: none;
    appearance: none;
    text-align-last: center; /* Center the selected text */
    color: white;
    background-color: transparent; /* Allow background color to be set dynamically */
}


  

  #newLogoTable {
    font-size: 18px; /* Set font size to 9px for the entire table */
  }
  #newLogoTable select,
  #newLogoTable input[type="date"] {
    font-size: 18x; /* Set font size for dropdowns and date inputs */
  }
  #newLogoTable option {
    font-size: 18x; /* Ensure dropdown options inherit the same font size */
  }


#allTasksList,
#focusTasksList {
  background: transparent !important;
  background-color: transparent !important;
  backdrop-filter: none !important;
}


  
/* Style the select dropdown */
.select-colour {
    background-color: #692AD9; /* Match your theme */
    color: white;
    border: 1px solid #692AD9;
    padding: 5px;
    font-size: 18px;
    text-align: center;
    appearance: none; /* Remove default styling */
    -webkit-appearance: none;
    -moz-appearance: none;
}

/* Style the dropdown options */
.select-colour option {
    background-color: #692AD9; /* Background matches select */
    color: white; /* White text */
}

/* Ensure selected option is visible when focused */
.select-colour:focus {
    outline: none;
    border: 1px solid white;
}



/* Preserve white space and wrap text in editable cells */
.editable-cell {
    white-space: pre-wrap;
}

/* Style for the editable textarea */
.editable-cell textarea {
    width: 100%;
    height: 100%;
    resize: none;
    border: none;
    outline: none;
    background-color: transparent; /* Optional: Make the textarea background transparent */
    color: white; /* Match the text color */
}

/* Style the status dropdown */
.status-select {
    background-color: transparent;
    color: white; /* Match the text color */
    border: none;
    outline: none;
    -webkit-appearance: none; /* Remove default styling */
    -moz-appearance: none;
    appearance: none;
    text-align-last: center; /* Center the selected text */
}

/* Adjust the select element to fill the cell */
.status-cell .status-select {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
}

/* Ensure the options have readable text */
.status-select option {
    color: black; /* Option text color */
    background-color: white; /* Option background color */
}


 .custom-modal-width {
    max-width: 80%;
  }


/* Using attribute selectors to target specific data-field values */
.editable-cell[data-field="recentEvents"],
.editable-cell[data-field="plannedEvents"] {
    text-align: left !important;
}


/* Make all table text white */
#contactsTable th,
#contactsTable td {
    color: white;
}
/* Style the table headers */
#contactsTable thead th {
    background-color: white;
    color: black;
}
/* Preserve new lines and wrap text in editable cells */
.editable-cell {
    white-space: pre-wrap;
}

/* Style for the inprogressTasksMain to take up available space */
.taskDivHeight {
    flex-grow: 1; /* Allows the div to expand and fill the available space */
    width: 100%; /* Take up full width of its parent */
    min-height:40vh;
	 background-color: rgba(128, 128, 128, 0.2); /* Grey with 80% transparency */
	 margin-bottom: 300px; /* Adds 200px of space below the div */
}
.reducedHeight{
	 height: 10px;
}
 #mindMapModal .modal-dialog {
        max-width: 90%;
    }
/* Ensure taskModal appears above timelineViewModal */
#taskModal {
    z-index: 1060; /* Default Bootstrap modal z-index is 1050 */
}
.urgent-task {
    background-color: #a83232 !important; /* Deep red for urgency */
    color: white  !important; /* Ensure text is readable */
    border-left: 6px solid #f00; /* Optional: add an accent border */
	
}

/* Targeting directly the vis timeline items */
.vis-timeline .vis-itemset .vis-item,
.vis-timeline .vis-itemset .vis-item.vis-selected .vis-item-content {
    outline: none !important;
    border-color: transparent !important; /* In case it's a border instead of an outline */
	
}

.vis-timeline .vis-item .vis-item-content {
    background-color: #007bff !important; /* Set this to your preferred item color */
    padding: 0 !important; /* Remove any unwanted padding */
    color: white !important; /* Adjust text color as needed */
}

/* General item color change */
.vis-item {
    background-color: #f0f0f0 !important; /* Light grey background */
    color: black !important; /* Black text color */
}

/* For the modal content: white background, black text, and a black border */
#focusModal .modal-content {
  background: linear-gradient(135deg, #6A11CB 0%, #684EEC 100%) !important; /* Softer gradient */
  background-size: cover !important;
  background-color: rgba(229, 229, 229, 0.8) !important; /* Semi-transparent overlay */
  color: black !important;
  border: 2px solid black !important;
  border-radius: 10px !important;
  padding: 20px !important;
  backdrop-filter: blur(5px) !important;
}


#focusModal .btn.btn-primary {
  background-color: #007bff !important;
  border-color: #007bff !important;
  color: #fff !important;
}


/* For the modal dialog: set the maximum width to 70% of the screen */
#focusModal .modal-dialog {
  max-width: 85% !important;
}

#focusModal .modal-title,
#focusModal h6,
#focusModal .input-group-text,
#focusModal .btn {
    color: white;
}


#newLogoModal .modal-content {
  background: linear-gradient(135deg, #6A11CB 0%, #684EEC 100%) !important; /* Softer gradient */
  background-size: cover !important;
  background-color: rgba(229, 229, 229, 0.5) !important; /* Semi-transparent overlay */
  color: black !important;
  border: 2px solid black !important;
  border-radius: 10px !important;
  padding: 20px !important;
  backdrop-filter: blur(5px) !important;
}


#newLogoTable th.last-interaction,
#newLogoTable td.last-interaction {
  width: 100px !important;
}

#newLogoTable th.last-interaction2,
#newLogoTable td.last-interaction2 {
  width: 150px !important;
}


#newLogoTable {
  color: white;
}
/* On hover, make the text white and bold */
#newLogoTable tr:hover {
  color: white;
  font-weight: bold;
}
#newLogoTable .newLogoSectorSelect,
#newLogoTable .newLogoStageSelect,
#newLogoTable .newLogoDXCRevenueSelect,
#newLogoTable .newLogoJobRoleSelect,
#newLogoTable .newLogoLastInteraction {
  background-color: transparent;
  color: white;
  border: none; /* Remove the white border */
  outline: none; /* Remove any focus outlines if present */
}
/* Style the dropdown options so they're visible against a dark background */
#newLogoTable .newLogoSectorSelect option,
#newLogoTable .newLogoDXCRevenueSelect option,
#newLogoTable .newLogoStageSelect option,
#newLogoTable .newLogoJobRoleSelect option,
#newLogoTable .newLogoLastInteraction option {
  background-color: #333; /* dark background so white text is visible */
  color: white;
}

/* Hide all inputs by default */
#newLogoAddContactForm input,
#newLogoAddContactForm select {
  display: none;
}

/* Always show the submit button */
#newLogoAddContactForm button {
  display: inline-block;
}

/* When a special class is added, show all inputs and selects */
#newLogoAddContactForm.show-inputs input,
#newLogoAddContactForm.show-inputs select {
  display: inline-block;
}



#newLogoTable th,
#newLogoTable td {
  width: 180px !important;  /* force each col to 180px */
  white-space: normal;      /* let text wrap so row grows in height */
  word-wrap: break-word;    
  overflow-wrap: break-word;
}

#newLogoTable {
  width: 100%; /* or whatever width you want for the whole table */
  table-layout: fixed;
}


/* Style for the contacts table */
#contactsTable th, #contactsTable td {
    text-align: center;
    vertical-align: middle;
}

/* Ensure the textarea fits within the cell */
.editable-cell textarea {
    width: 100%;
    height: 100%;
    resize: none;
    border: none;
    outline: none;
}

/* Optional: Add some padding to cells */
#contactsTable td {
    padding: 8px;
}

.taskDivFocus {
  margin: 10px 5px; /* Increased vertical margin for more space */
  padding: 20px; /* Increased padding for better spacing */
  cursor: move;
  white-space: pre-wrap; /* Wrap text */
  word-wrap: break-word;
  background-color: #EDF2FA; /* Light blue-grey background */
  border-radius: 10px; /* Rounded corners */
}




/* Add this to your CSS file or inside a <style> tag */
.left-align {
    text-align: left !important;
}




.editable-cell,
.editable.project-Row {
  white-space: pre-wrap;  /* So new lines display correctly */
  overflow-wrap: break-word;
}





    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark" style="padding: 0.5rem 1rem;">
    <div class="d-flex align-items-center mr-auto">
        <!-- New div for displaying the selected customer name -->
        <div class="clickMe" id="selectedCustomerDiv">
            <h4 id="selectedCustomerText2" class="mb-0" style="color:white;">Select a Customer</h4>
        </div>
    </div>
    <div class="ml-auto d-flex align-items-center">
		<select class="form-control form-control-sm mr-2" id="customerDropDown" style="width: auto; display: inline-block;">
		  <option value="-1">Select Customer</option>
		  <!-- Customers populated dynamically here -->
		  <!-- Add this hard-coded option: -->
		  <option value="focus">Focus</option>
		</select>

        <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addCustomerModal">
            Add Customer
        </button>
        <!-- Cog Icon for options -->
        <button id="optionsButton" class="btn btn-sm" style="color: white;">
            <i class="fas fa-cog"></i>
        </button>
    </div>
</nav>

<!-- Mind Map Modal -->
<div class="modal fade" id="mindMapModal" tabindex="-1" role="dialog" aria-labelledby="mindMapModalLabel" aria-hidden="true" style="height: 98vh;">
  <div class="modal-dialog modal-xl" role="document"> <!-- modal-xl for wider modals -->
    <div class="modal-content">
      <div class="modal-header" style="display: flex; align-items: center; width: 100%;">
        <h5 class="modal-title" id="mindMapModalLabel" style="flex-grow: 1;">Mind Map</h5>
        
        <!-- Moved Export Button to the Right -->
        <button id="exportMind" style="background: none; border: none; padding: 5px 10px; cursor: pointer; font-size: 16px; color: grey;">
          Export
        </button>

        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="mindmapDiv" tabindex="0" style="width: 100%; background: white; height: 800px;"></div>
      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>



<!-- Focus Modal -->
<div class="modal fade" id="focusModal" tabindex="-1" role="dialog" aria-labelledby="focusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content" style="min-height:600px;">
      <div class="modal-header">
        <h5 class="modal-title" id="focusModalLabel">Focus Tasks</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="position:absolute; right:15px; top:15px;">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Top row for adding new tasks -->
        <div class="input-group mb-3">
          <input type="text" class="form-control" id="newFocusTaskInput" placeholder="Add New Task -- press enter to submit">
          <div class="input-group-append">
            <button class="btn btn-primary" type="button" id="saveFocusTaskButton">Save Task</button>
          </div>
        </div>
        <!-- Dual list container -->
<div class="d-flex" style="gap:10px;">
  <div class="border p-2" id="allTasksList" style="min-height:400px; width:50%;  white-space: pre-wrap; word-wrap: break-word;">
  <input type="text" id="taskSearchBox" placeholder="Search tasks..." style="width: 50%; margin-bottom: 10px;">
<h5 style="color: white; font-family: Arial, Helvetica, sans-serif; text-align: center;"><br>All Tasks</h5></div>
  <div class="border p-2" id="focusTasksList" style="min-height:400px; width:50%;  white-space: pre-wrap; word-wrap: break-word;">
<h5 style="color: white; font-family: Arial, Helvetica, sans-serif; text-align: center;">Focus Tasks</h5></div>
</div>


      </div>
      <div class="modal-footer">
        <!-- No additional buttons needed -->
      </div>
    </div>
  </div>
</div>


<div id="backgroundContainer"></div>
<!-- Main Div -->


<div class="container-fluid" id="mainDiv">
    <!-- Relationship Div -->
    <div class="row" id="relationship" style="align-items: center;">
        <div class="col-1">
            <div class="clickMe" style="text-align: center;">
                <h6 id="clickAddRelationship">Contacts</h6>
            </div>
        </div>
        <div class="col-11 horizontal-scroll" id="RelationshipItemsDiv1">
		<!-- Contacts Table -->
				<div class="contacts-table-container col-12">
						<table id="contactsTable" class="table table-hover table-sm">
							<thead>
								<tr>
									<th>Name</th>
									<th>Job Role</th>
									<th>Exec Mapping</th>
									<th class="status-header">Status</th>
									<th class="left-align">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Recent Exec Connects</th>
								<th class="left-align">&nbsp;&nbsp;&nbsp;Planned Exec Conencts</th>
								</tr>
							</thead>
							<tbody id="contactsTableBody">
								<!-- Contacts will be dynamically inserted here -->
							</tbody>
						</table>
			</div>
        </div>
    </div>

<!-- Projects Div with Custom Percentage Widths and 1% Margins -->
<div class="row" id="projects" style="width: 100%; overflow: hidden; text-align: center;"> <!-- Ensures that the floating elements are contained within the row -->
    <!-- First Column for "Projects" with adjusted width and 1% margin -->
    <div style="width: calc(10% - 1%); float: left; text-align: center;margin-right: 1%;">
        <div id="addProjectText" class="clickMe"><br><br><br><br><h6>Projects&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</h6>
        </div>
    </div>
    <!-- Ideas Column with adjusted width -->
    <div style="width: calc(18% - 1%); float: left; margin-right: 1%;">
        <div class="custom-header" style="background-color: white; color: #5f249f;text-align: center;">
            <h5>Ideas</h5>
        </div><div id="projectIdeas" class="project-column"></div>
        <!-- Content for Ideas -->
    </div>
    <!-- Discussing with Customer Column -->
    <div style="width: calc(18% - 1%); float: left; margin-right: 1%;">
        <div class="custom-header" style="background-color: white; color: #5f249f;text-align: center;">
            <h5 class="clickMe" style="text-align: center;">Discussing with Customer</h5>
        </div><div id="projectDiscuss"  class="project-column"></div>
        <!-- Content for Discussing with Customer -->
    </div>
    <!-- Preparing a Proposal Column -->
    <div style="width: calc(18% - 1%); float: left; margin-right: 1%;">
        <div class="custom-header" style="background-color: white; color: #5f249f;text-align: center;">
            <h5 class="clickMe">Preparing a Proposal</h5>
        </div><div id="projectProposals" class="project-column"></div>
        <!-- Content for Preparing a Proposal -->
    </div>
    <!-- Waiting for Feedback Column -->
    <div style="width: calc(18% - 1%); float: left; margin-right: 1%;">
        <div class="custom-header" style="background-color: white; color: #5f249f;text-align: center;">
            <h5 class="clickMe" >Waiting for Feedback</h5>
        </div><div id="projectFeedback" class="project-column"></div>
        <!-- Content for Waiting for Feedback -->
    </div>
    <!-- Approved Column, without margin-right since it's the last column -->
    <div style="width: calc(18% - 1%); float: left;">
        <div class="custom-header" style="background-color: white; color: #5f249f;text-align: center;">
            <h5 class="clickMe">Approved</h5>
        </div><div id="projectClosed" class="project-column"></div>
        <!-- Content for Approved -->
    </div>
</div>


    <!-- Value Add Div -->
    <div class="row" id="ValueAdd"  style="align-items: center;">
        <div class="col-2">
            <div class="content">
                <h6 class="clickMe" id="futureItemAddHere"> &nbsp; &nbsp; &nbsp; Strategic Planning<br>&nbsp; &nbsp; &nbsp; & Value Add Ideas</h6>
            </div>
        </div>
        <div class="col-10  horizontal-scroll clickMe"  id="futureItemsDiv"></div>
    </div>

	<!-- Tasks / Admin Div -->
<div class="row" id="admin" style="align-items: center;  border-bottom: 0 !important;">
   <div class="col-2"  style="align-self: flex-start;"><br><br><h6 id="clickAddTasksNoProject" class="clickMe">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tasks</h6></div>
	<div class="col-10">
    
	<div style="width: 7%;min-height: 10px;min-width: 10px;   float: left;">
        <div class="content">
        </div>
    </div>
    <div style="width: 20%; float: left; text-align: center; ">
        <div class="content">
            <h6>Not started</h6>
            <div class="taskDivHeight sortableContainer" id="notStartedTasksMain"></div>
        </div>
    </div>
    <div style="width: 7%; float: left;min-height: 10px;min-width: 10px;">
        <div class="content">
        </div>
    </div>
    <div style="width: 20%; float: left;text-align: center; ">
        <div class="content">
            <h6>Waiting on others</h6>
            <div class="taskDivHeight sortableContainer" id="waitingTasksMain"></div>
        </div>
    </div>
    <div style="width: 7%; float: left;min-height: 10px;min-width: 10px;">
        <div class="content">
        </div>
    </div>
    <div style="width: 20%; float: left;text-align: center;">
        <div class="content">
            <h6>In progress</h6>
            <div class="taskDivHeight sortableContainer" id="inprogressTasksMain"></div>
        </div>
    </div>
    <div style="width: 7%; float: left;min-height: 10px;min-width: 10px;">
        <div class="content">
        </div>
    </div>
	
</div>
</div>
   
   
</div>

<!-- Application Status Modal -->
<div class="modal fade" id="appStatusModal" tabindex="-1" role="dialog" aria-labelledby="appStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg custom-modal-width" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="appStatusModalLabel">Application Status</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Container where the modules and application boxes are rendered -->
        <div id="modulesContainer"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="saveAppStatus">Save</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Optional trigger button (you can replace this with your own trigger) -->





<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1" role="dialog" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCustomerModalLabel">Add New Customer</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addCustomerForm">
                    <div class="form-group">
                        <label for="customerName">Customer Name</label>
                        <input  autocomplete="off" type="text" class="form-control" id="customerName">
                    </div>
                    <button type="submit" class="btn btn-primary">Save Customer</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Contact Modal -->
<div class="modal fade" id="editContactModal" tabindex="-1" role="dialog" aria-labelledby="editContactModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <!-- Modal header with title and close button -->
      <div class="modal-header">
        <h5 class="modal-title" id="editContactModalLabel">Edit Contact</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="position: absolute; right: 15px; top: 15px;">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <!-- Modal body with form fields -->
      <div class="modal-body">
        <form id="editContactForm">
          <!-- Contact Name -->
          <div class="form-group">
            <label for="editContactName">Contact Name</label>
            <input type="text" class="form-control" id="editContactName">
          </div>
          <!-- Job Role -->
          <div class="form-group">
            <label for="editContactJobRole">Job Role</label>
            <input type="text" class="form-control" id="editContactJobRole">
          </div>
          <!-- Email -->
          <div class="form-group">
            <label for="editContactEmail">Email</label>
            <input type="email" class="form-control" id="editContactEmail">
          </div>
          <!-- Phone -->
          <div class="form-group">
            <label for="editContactPhone">Phone</label>
            <input type="tel" class="form-control" id="editContactPhone">
          </div>
          <!-- LinkedIn -->
          <div class="form-group">
            <label for="editContactLinkedIn">LinkedIn</label>
            <input type="url" class="form-control" id="editContactLinkedIn">
          </div>
        </form>
      </div>
      <!-- Modal footer with action buttons -->
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="deleteContactButton">Delete</button>
        <button type="button" class="btn btn-primary" id="saveContactChangesButton">Save Changes</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>



<!-- Add Relationship Item Modal -->
<div class="modal fade" id="addRelationshipModal" tabindex="-1" role="dialog" aria-labelledby="addRelationshipModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <!-- ...existing modal header... -->
            <div class="modal-body">
                <form id="addRelationshipForm">
                    <!-- Contact Name -->
                    <div class="form-group">
                        <label for="contactName">Contact Name</label>
                        <input autocomplete="off" type="text" class="form-control" id="contactName" placeholder="Enter contact name">
                    </div>
                    <!-- Job Role -->
                    <div class="form-group">
                        <label for="contactJobRole">Job Role</label>
                        <input type="text" class="form-control" id="contactJobRole" placeholder="Enter job role">
                    </div>
                    <!-- Email -->
                    <div class="form-group">
                        <label for="contactEmail">Email</label>
                        <input autocomplete="off" type="email" class="form-control" id="contactEmail" placeholder="Enter email">
                    </div>
                    <!-- Phone -->
                    <div class="form-group">
                        <label for="contactPhone">Phone</label>
                        <input autocomplete="off" type="tel" class="form-control" id="contactPhone" placeholder="Enter phone number">
                    </div>
                    <!-- LinkedIn -->
                    <div class="form-group">
                        <label for="contactLinkedIn">LinkedIn</label>
                        <input autocomplete="off" type="url" class="form-control" id="contactLinkedIn" placeholder="Enter LinkedIn profile URL">
                    </div>
                    <button type="submit" id="addContactButton" class="btn btn-primary">Add Contact</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </form>
            </div>
            <!-- ...existing modal footer... -->
        </div>
    </div>
</div>




<!-- Edit Item Modal -->
<div class="modal fade" id="editItemModal" tabindex="-1" role="dialog" aria-labelledby="editItemModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editItemModalLabel">Edit Item</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editItemForm">
                    <div class="form-group">
                        <label for="editItemTitle">Title</label>
                        <input type="text" class="form-control" id="editItemTitle">
                    </div>
                    <div class="form-group">
                        <label for="editItemContent">Item Content</label>
                        <textarea class="form-control" id="editItemContent" rows="3"></textarea>
                    </div>
					<div class="form-group">
						<label for="editRelationshipItemNotes">Notes</label>
						<div id="editRelationshipItemNotes"></div> <!-- Summernote editor will be initialized here -->
					</div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveItemChanges">Save Changes</button>
                <button type="button" class="btn btn-success" id="deleteItem">Complete</button>
            </div>
        </div>
    </div>
</div>



<!-- Add Project Item Modal -->
<div class="modal fade" id="addProjectModal" tabindex="-1" role="dialog" aria-labelledby="addProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProjectModalLabel">Add New Project</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addProjectForm">
                    <!-- Item Title Input -->
                    <div class="form-group">
                        <label for="projectTitle">Project</label>
                        <input autocomplete="off" type="text" class="form-control" id="projectTitle">
                    </div>
                    <!-- Relationship Item Input -->
                    <div class="form-group">
                        <label for="projectValue">Project Value</label>
                        <input type="text"  autocomplete="off" class="form-control" id="projectValue">
                    </div>
                    <!-- Relationship Item Input -->
                    <div class="form-group">
                        <label for="projectDate">Project Date</label>
                        <input type="date" class="form-control" id="projectDate">
                    </div>
                    <button type="submit" id="addProjectButton" class="btn btn-primary">Add Project</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>






<div id="projectModal" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update Project</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="updateProjectForm">
          <div class="form-group">
            <label for="projectNameInput">Project</label>
            <input autocomplete="off" type="text" class="form-control" id="projectNameInput">
          </div>
          <div class="form-group">
            <label for="projectValueInput">Value</label>
            <input type="text" class="form-control" id="projectValueInput">
          </div>
          <div class="form-group">
            <label for="projectDateInput">Date</label>
            <input type="date" class="form-control" id="projectDateInput">
          </div>
          <div class="form-group">
            <label for="projectStage">Stage</label>
            <select class="form-control" id="projectStageInput">
              <option value="idea">Idea</option>
              <option value="discuss">Discuss</option>
              <option value="proposal">Proposal</option>
              <option value="feedback">Feedback</option>
              <option value="won">Won</option>
              <option value="lost">Lost</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="saveProject">Save</button>       
		<button type="button" class="btn btn-success" id="viewTasks">Tasks</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
 
      </div>
    </div>
  </div>
</div>



<!-- Task Modal -->
<div id="taskModal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" style="width: 90%;" role="document">
    <div class="modal-content">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: start;">
        <div><h5 id="projectTitleDiv"></h5></div>
        <!-- Flex container for inputs -->
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
          <!-- Task input -->
          <input type="text" class="form-control" placeholder="Add Tasks --- press enter to submit" id="addTaskInput" style="width: 300px;">
          <!-- Notes and other controls -->
          <div>
            <button style="margin-top:17px;" type="button" class="btn btn-secondary btn-sm" id="toggleNotesBtn">Notes</button>
            <div><input type="checkbox" id="hideCompleteTasks"> Hide complete tasks</div>
          </div>
        </div>
        <!-- Close button -->
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="position: absolute; right: 15px; top: 15px;">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body centeredElement" style="text-align: center; width: 90%">
        <textarea id="notesInput" class="notes-input" style="display: none; width: 50%; height: 30em; margin-bottom: 20px;"></textarea>
        <table id="taskTable" class="table table-hover table-sm">
          <thead style="background-color: rgb(0, 0, 0); height: 24px; font-size: 16px; font-weight: 700; color: rgb(255, 255, 255); text-align: center;">
            <tr class="thead-dark">
              <th style="width: 38%;">Task</th>
              <th style="width: 14%;">Stage</th>
              <th style="width: 10%;" id="targetDateHeader">Target Date</th>
              <th style="width: 10%;">Task Owner</th>
              <th style="width: 28%;">Comments</th>
            </tr>
          </thead>
          <tbody id="projectTableBody">
            <!-- Task rows will be dynamically added here -->
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" style="display: none;" id="hideTaskModal" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>


<!-- New Logo Modal -->
<!-- New Logo Modal -->
<div class="modal fade" id="newLogoModal" tabindex="-1" role="dialog" aria-labelledby="newLogoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen modal-dialog-scrollable" role="document">
    <div class="modal-content" style="min-height: 100vh;">
      <div class="modal-header">
       <h5 class="modal-title" id="newLogoModalLabel" style="color: white;">New Logo Tracker</h5>
		<form id="newLogoAddContactForm" class="form-inline mb-3">
          <input type="text" class="form-control mr-2" id="newLogoContactNameInput" placeholder="Contact Name" required autocomplete="off">
          <input type="text" class="form-control mr-2" id="newLogoAccountInput" placeholder="Account Name" required autocomplete="off">

          <!-- Sector dropdown -->
<select id="newLogoSectorInput" class="form-control mr-2" required="">
  <option value="">Select Sector</option>
  <option value="Technology">Technology</option>
  <option value="Banking">Banking</option>
  <option value="Insurance">Insurance</option>
  <option value="Financial Services">Financial Services</option>
  <option value="Healthcare">Healthcare</option>
  <option value="Retail">Retail</option>
  <option value="Manufacturing">Manufacturing</option>
  <option value="Telecommunications">Telecommunications</option>
  <option value="Energy">Energy</option>
  <option value="Construction">Construction</option>
  <option value="Transport & Logistics">Transport & Logistics</option>
  <option value="Education">Education</option>
  <option value="Hospitality">Hospitality</option>
  <option value="Media & Entertainment">Media & Entertainment</option>
  <option value="Public Sector">Public Sector</option>
  <option value="Other">Other</option>
</select>


          <!-- Stage dropdown -->
<select id="newLogoStageInput" class="form-control mr-2">
  <option value="">Stage</option>
  <option value="1">Prospect Identified</option>
  <option value="2">Initial Contact</option>
  <option value="3">Meeting Booked</option>
  <option value="4">Opportunities Logged</option>
</select>


          <!-- Job Role dropdown -->
          <select id="newLogoJobRoleInput" class="form-control mr-2" required>
<option value="">(Choose Job Role)</option>
              <option value="CEO">CEO</option>
              <option value="CIO">CIO</option>
              <option value="CFO">CFO</option>
              <option value="IT Director / Head of IT">IT Director / Head of IT</option>
              <option value="Service Delivery Manager">Service Delivery Manager</option>
              <option value="IT Operations">IT Operations</option>
              <option value="Architect">Architect</option>
              <option value="Digital Transformation Leader">Digital Transformation Leader</option>
              <option value="Procurement">Procurement</option>
              <option value="Platform Owner">Platform Owner</option>
              <option value="Product Owner">Product Owner</option>
              <option value="Other">Other</option>
          </select>

          <select id="newLogoDXCRevenueInput" class="form-control mr-2 d-none">
            <option value="">DXC Revenue</option>
            <option value="None">None</option>
            <option value="Little">Little</option>
            <option value="Some">Some</option>
            <option value="High">High</option>
          </select>
          <button type="submit" id="newLogoContactAddButton" class="btn btn-primary">Add Contact</button>
        </form>&nbsp;
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="position: absolute; right:15px; top:15px;">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <!-- Add new contact form (unchanged) -->
        

        <!-- Filter row for accounts -->
        <div class="form-row mb-2">
          <div class="col">
            <input type="text" class="form-control" id="filterAccountInput" placeholder="Filter by Account">
          </div>
          <div class="col" style="display: none;">
            <select id="filterStageInput" class="form-control">
              <option value="">All Stages</option>
              <option value="Prospect Identified">Prospect Identified</option>
              <option value="Initial Contact">Initial Contact</option>
              <option value="Meeting Booked">Meeting Booked</option>
              <option value="Opportunities Logged">Opportunities Logged</option>
            </select>
          </div>
          <div class="col">
            <select id="filterSectorInput" class="form-control">
              <option value="">All Sectors</option>
              <option value="Technology">Technology</option>
              <!-- ... etc ... -->
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="col">
            <select id="filterDXCRevenueInput" class="form-control d-none">
              <option value="">All DXC Revenue</option>
              <option value="None">None</option>
              <option value="Little">Little</option>
              <option value="Some">Some</option>
              <option value="High">High</option>
            </select>
          </div>
        </div>
        <!-- Focus Prospect Switch -->
 <div class="d-flex align-items-center">
  <div class="form-check mb-2 mr-3">
    <input class="form-check-input"  type="checkbox" id="focusProspectSwitch">
    <label class="form-check-label"  for="focusProspectSwitch"><div  style="color: white;">Focus Prospect</div></label>
  </div>
  <button id="showAccountsButton" class="btn btn-sm btn-secondary">
    Show Accounts
  </button>
</div>


        <!-- Container that lists accounts -->
        <div id="newLogoAccountsList" style="margin-bottom: 20px;">
          <!-- Filled dynamically with account tiles or table rows -->
        </div>

        <!-- Contact filter & contacts table for the selected account -->
        <div id="contactsContainer" style="display:none;">
          <hr>
          <h4 style="color: white;" id="selectedAccountHeading"></h4>
		   <!-- Right side: two new dropdowns -->
  <div style="display: flex; gap: 1rem;">
    <!-- DXC Account? -->
    <select id="dxcAccountSelect" class="form-control" style="width: auto;">
      <option value="">DXC Account? (Please Select)</option>
      <option value="yes">DXC Account - Yes</option>
      <option value="no">DXC Account - No</option>
    </select>

    <!-- DXC Embedded? -->
    <select id="dxcEmbeddedAccountSelect" class="form-control" style="width: auto;">
      <option value="">DXC Embedded? (Please Select)</option>
      <option value="yes">Very Active Account - Yes</option>
      <option value="no">Very Active Account - No</option>
    </select>
  </div>
</div>
          <input type="text" class="form-control mb-2" id="filterContactInput" placeholder="Filter by Contact" style="display: none;">
          <div style="overflow-x:auto;"><br>
            <table style="width: 100%; table-layout: fixed;" class="table table-hover table-sm" id="newLogoTable">
              <thead style="font-family: Arial, Helvetica, sans-serif; font-size: 18px;">
                <tr>
                  <th  style="width: 10% !important;">Contact Name</th>
                  <th  style="width: 180px;">Job Role</th>
				   <th  style="width: 180px;">Stage</th>
                  <th class="last-interaction" style="width: 100px;">Last Interaction</th>
                  <th style="width: 180px;">Notes</th>
                  <th style="width: 180px;">Next Steps</th>
                  <th class="last-interaction2" style="width: 100px;">Phone / Email / LinkedIn</th>
                </tr>
              </thead>
              <tbody id="newLogoTableBody" style="font-family: 'Roboto', 'Segoe UI', 'Arial', sans-serif; font-size: 18px;">
                <!-- Contacts for the chosen account appear here -->
              </tbody>
            </table>
			<div id="newlogodeletebuttonspace"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- Edit New Logo Contact Modal -->
<div class="modal fade" id="editNewLogoContactModal" tabindex="-1" role="dialog" aria-labelledby="editNewLogoContactModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editNewLogoContactModalLabel">Edit Contact Info</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="position: absolute; right:15px; top:15px;">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="editNewLogoContactForm">
  <input type="hidden" id="editNewLogoContactId">

  <!-- New field for editing account name -->
  <div class="form-group">
    <label for="editAccountNameInput">Account Name</label>
    <input type="text" class="form-control" id="editAccountNameInput" placeholder="Account Name" required>
  </div>

  <!-- Job Role dropdown -->
  <div class="form-group">
    <label for="editJobRoleSelect">Job Role</label>
    <select id="editJobRoleSelect" class="form-control">
      <option value="">(Choose Job Role)</option>
      <option value="CEO">CEO</option>
      <option value="CIO">CIO</option>
      <option value="CFO">CFO</option>
      <option value="IT Director / Head of IT">IT Director / Head of IT</option>
      <option value="Service Delivery Manager">Service Delivery Manager</option>
      <option value="IT Operations">IT Operations</option>
      <option value="Architect">Architect</option>
      <option value="Digital Transformation Leader">Digital Transformation Leader</option>
      <option value="Procurement">Procurement</option>
      <option value="Platform Owner">Platform Owner</option>
      <option value="Product Owner">Product Owner</option>
      <option value="Other">Other</option>
    </select>
  </div>

  <div class="form-group">
    <label for="editPhoneInput">Phone</label>
    <input type="text" class="form-control" id="editPhoneInput">
  </div>
  <div class="form-group">
    <label for="editEmailInput">Email</label>
    <input type="email" class="form-control" id="editEmailInput">
  </div>
  <div class="form-group">
    <label for="editLinkedInInput">LinkedIn</label>
    <input type="text" class="form-control" id="editLinkedInInput">
  </div>
  <div class="form-group">
    <label for="editSectorInput2">Sector</label>
    <select id="editSectorInput2" class="form-control">
      <option value="">Select Sector</option>
      <option value="Technology">Technology</option>
      <option value="Banking">Banking</option>
      <option value="Insurance">Insurance</option>
      <option value="Financial Services">Financial Services</option>
      <option value="Healthcare">Healthcare</option>
      <option value="Retail">Retail</option>
      <option value="Manufacturing">Manufacturing</option>
	  </select>
      </div>
	  <div class="form-check">
  <input 
    class="form-check-input" 
    type="checkbox" 
    id="editAccountFocusCheckbox">
  <label 
    class="form-check-label" 
    for="editAccountFocusCheckbox">
    Focus this Account
  </label>
   
</div> </form>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="saveNewLogoContact">Save</button>
        <button type="button" class="btn btn-danger" id="deleteNewLogoContact">Delete</button>
      </div>
	
    </div>
  </div>
</div>
</div>





<!-- Add futre Item Modal -->
<div class="modal fade" id="addFutureItemModal" tabindex="-1" role="dialog" aria-labelledby="addFutureItemModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFutureItemModalLabel">Add New Future Item</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addFutureItemForm">
                    <!-- Item Title Input -->
                    <div class="form-group">
                        <label for="futureItemTitle">Item Title</label>
                        <input autocomplete="off" type="text" class="form-control" id="futureItemTitle">
                    </div>
                    <!-- Future Item Input -->
                    <div class="form-group">
                        <label for="futureItemContent">Future Item Content</label>
                        <input  autocomplete="off" type="text" class="form-control" id="futureItemContent">
                    </div>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>






<div class="modal fade" id="editFutureItemModal" tabindex="-1" role="dialog" aria-labelledby="editFutureItemModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editFutureItemModalLabel">Edit Future Item</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editFutureItemForm">
                    <div class="form-group">
                        <label for="editFutureItemTitle">Item Title</label>
                        <input type="text" class="form-control" id="editFutureItemTitle">
                    </div>
                    <div class="form-group">
                        <label for="editFutureItemContent">Item Content</label>
                        <textarea class="form-control" id="editFutureItemContent" rows="3"></textarea>
                    </div>
					<div class="form-group">
						<label for="editFutureItemNotes">Notes</label>
						<div id="editFutureItemNotes"></div> <!-- Summernote editor will be initialized here -->
					</div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveFutureItemChanges">Save Changes</button>
                <button type="button" class="btn btn-success" id="deleteFutureItem">Complete</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editTaskModal" tabindex="-1" role="dialog" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <div class="form-group">
                        <label for="editTaskField">Task</label>
                        <input type="text" class="form-control" id="editTaskField">
                    </div>
                    <div class="form-group">
                        <label for="editTaskComments">Comments</label>
                        <textarea class="form-control" id="editTaskComments" rows="3"></textarea>
                    </div>
                    <!-- Simple HTML Checkbox for High Priority -->
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="editTaskPriority">
                        <label class="form-check-label" for="editTaskPriority">High Priority</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-primary" id="saveTaskChanges">Save Changes</button>
				 <button type="button" class="btn btn-success" id="deleteItemPriorityTask">Complete</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				</div>
        </div>
    </div>
</div>


<div class="modal fade" id="addTaskModal" tabindex="-1" role="dialog" aria-labelledby="addTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTaskModalLabel">Add Task</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <div class="form-group">
                        <label for="newTaskField">Task</label>
                        <input  autocomplete="off" type="text" class="form-control" id="newTaskField" placeholder="Enter task details">
                    </div>
                    <div class="form-group">
                        <label for="newTaskComments">Comments</label>
                        <textarea class="form-control" id="newTaskComments" rows="3" placeholder="Add any comments"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNewTask">Save Task</button>
            </div>
        </div>
    </div>
</div>
<!-- Account Notes Modal -->
<div class="modal fade" id="textEditorModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document" style="max-width: 80%;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">Notes:</h5>
        <!-- MindMap Button -->
        <button type="button" class="btn btn-sm btn-primary  ml-auto" id="openMindMap">Planning</button>&nbsp;&nbsp;&nbsp;
		<button type="button" id="openAppStatusButton" class="tn btn-sm btn-primary">Open Adoption Status</button>
        <!-- Close Button -->
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="textEditor" style="height: 700px;"></div>
      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>



<!-- Project  Notes Modal -->
<div class="modal fade" id="textEditorModalProject" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document" style="max-width: 80%;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabelProject">Notes:</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="textEditorProject" style="height: 700px;"></div>
      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>



<!-- Options Modal -->
<div class="modal fade" id="optionsModal" tabindex="-1" role="dialog" aria-labelledby="optionsModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="optionsModalLabel">Options</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Placeholder for Opportunities Timeline View Button -->
        <button type="button" class="btn btn-primary" id="opportunitiesTimelineViewButton">Opportunities Timeline View</button>
		<!-- Import New Logos Button -->
<button type="button" class="btn btn-secondary" id="importNewLogosButton">Import New Logos</button>

<!-- Backup Data Button -->
<button type="button" class="btn btn-info" id="backupDataButton">Backup Data</button>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- Import New Logos Modal -->
<div class="modal fade" id="importNewLogosModal" tabindex="-1" role="dialog" aria-labelledby="importNewLogosModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="importNewLogosModalLabel">Import New Logos</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="position: absolute; right: 15px; top: 15px;">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Paste JSON data for new logos. Fields: accountName, contactName, sector, stage, jobRole, lastInteraction, notes, nextSteps, phone, email, linkedin</p>
        <textarea id="newLogosJsonInput" class="form-control" rows="10" placeholder='[{"accountName":"ABC Corp","contactName":"John Doe","sector":"Technology","stage":"Prospect Identified","jobRole":"CIO","lastInteraction":"2024-12-01","notes":"some notes","nextSteps":"call next week","phone":"12345","email":"john@example.com","linkedin":"https://linkedin.com/in/johndoe"}]'></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="importNewLogosConfirmButton">Import</button>
      </div>
    </div>
  </div>
</div>


<!-- Timeline View Modal -->
<div class="modal fade" id="timelineViewModal" tabindex="-1" role="dialog" aria-labelledby="timelineViewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width: 90%;" role="document">
    <div class="modal-content" style="height: 850px;">
      <div class="modal-header">
        <h5 class="modal-title" id="timelineViewModalLabel">Timeline View</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="overflow-y: auto;">
        <!-- Large empty div for content -->
        <div id="timelineContent" ><div id="visualization" style=""></div>
</div>
      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>



<div class="page-end-spacer"></div>




<script>
$(document).ready(function() {
const db = new Dexie("customerDatabase");
db.version(33).stores({
    customers: '++id,name,modified',
    projects: '++id,project,value,date,customerId,stage,modified,customerName',
    tasks: '++id,projectId,projectName,customerId,customerName,task,stage,dueDate,taskOwner,comments,order,priority,modified,urgent,focus',
    relationships: '++id,customerId,item,title,order,status,notes,modified',
    futureItems: '++id,customerId,item,title,order,status,notes,modified',
    notes: '++id,customerId,notes,modified',
    projectnotes: '++id,projectId,notes,modified',
    mindMaps: '++id,customerId,data',
	contacts: '++id,customerId,customerName,name,jobRole,email,phone,linkedIn,execMapping,status,recentEvents,plannedEvents,modified',
    newLogoContacts: '++id,accountName,contactName,sector,stage,jobRole,lastInteraction,notes,nextSteps,phone,email,linkedin,dxcRevenue,accountFocus,stageValue',
	backupInfo: 'id,lastBackupDate',
	newLogoAccounts: '++id,accountName,dxcAccount,dxcEmbeddedAccount',
	 MindMapData: '++id,customerId,data,modified',
	 appStatus: "++id, customerId"
});

db.open().catch(error => {
    console.error("Dexie open failed: " + error);
});



	
	// add customer modal
    $('#addCustomerForm').submit(function(e) {
        e.preventDefault();
        const customerName = $('#customerName').val();
        db.customers.add({name: customerName}).then(() => {
            // Refresh the customer dropdown
            loadCustomersIntoDropdown();
            $('#addCustomerModal').modal('hide');
            // Reset the form
            $('#addCustomerForm')[0].reset();
        }).catch(error => {
            console.error("Failed to add customer:", error);
        });
    });


// Function to load customers into the dropdown
function loadCustomersIntoDropdown() {
    // Empty the dropdown first
    $('#customerDropDown').empty();

    // Always re-append the "Select Customer" default
    $('#customerDropDown').append($('<option></option>').val("-1").text("Select Customer"));

    // Always re-append "Focus"
    $('#customerDropDown').append($('<option></option>').val("focus").text("Focus"));

    // **Add the "New Logo" option here** so it won't be overwritten
    $('#customerDropDown').append($('<option></option>').val("newLogo").text("New Logo"));

    // Now append actual customers from Dexie
    db.customers.orderBy('name').toArray().then(customers => {
        customers.forEach(customer => {
            $('#customerDropDown').append(
                $('<option></option>').val(customer.id).text(customer.name)
            );
        });
    }).catch(error => {
        console.error("Failed to load customers into dropdown:", error);
    });
}


 




//global variable 
let currentCustomerName = ""
let currentCustomerId = 0

 // Function to load and display relationship items for the selected customer
function loadAndDisplayRelationshipsForSelectedCustomer() {
    $('.modal').modal('hide');
	console.log("loading page refresh ")
	const selectedCustomerId = parseInt($('#customerDropDown').val(), 10); // Ensure the ID is an integer
	console.log(selectedCustomerId)
	currentCustomerId = selectedCustomerId
	//console.log(currentCustomerId)
	currentCustomerName = $('#customerDropDown option:selected').text();
	//console.log(currentCustomerName )
	// Get the selected option text
	var selectedCustomerName = currentCustomerName
	
		$('#waitingTasksMain').empty();	
		$('#inprogressTasksMain').empty();	
		$('#notStartedTasksMain').empty();
	
	// Update the h5 text with the selected customer name
	$('#selectedCustomerText2').text(selectedCustomerName);
	
	
    $('#RelationshipItemsDiv').empty(); // Empty the div at the start
	$('#projectIdeas').empty();
    $('#projectDiscuss').empty();
    $('#projectProposals').empty();
    $('#projectFeedback').empty();
    $('#projectClosed').empty();
    $('#futureItemsDiv').empty();
	
	
	// Load and display contacts
    loadAndDisplayContactsForSelectedCustomer();
	
	

	// Assuming selectedCustomerId is defined
if(selectedCustomerId === -1) {
    db.projects.orderBy('customerName').toArray().then(function(projects) {
        displayProjects(projects.filter(project => !["won", "lost", "discontinued", "idea"].includes(project.stage)));
    }).catch(error => {
        console.error("Failed to load projects:", error);
    });
} else {
    db.projects.where({customerId: selectedCustomerId}).sortBy('customerName').then(function(projects) {
        displayProjects(projects);
    }).catch(error => {
        console.error("Failed to load projects:", error);
    });
}

function displayProjects(projects) {
    projects.forEach(function(project) {
        var formattedDate = project.date ? formatDateToMMYYYY(project.date) : "";
        var tcv = parseInt(project.value);
        var formattedAmount = isNaN(tcv) ? "" : tcv.toLocaleString('en-GB', { style: 'currency', currency: 'GBP', minimumFractionDigits: 0 });

        // Conditionally prepend " - " if values are not empty
        var dateString = formattedDate ? " - " + formattedDate : "";
        var amountString = formattedAmount ? " - " + formattedAmount : "";
		 // Set customerNameString based on project.customerId
        var customerNameString = ""
		if (parseInt( selectedCustomerId) == -1){  customerNameString  = `${project.customerName} - `}
		
		console.log(customerNameString)
	//	console.log(project.customerId)

        let cardHtml = `
            <div class="card mb-3 projectItemCard cardClear2" style="min-height: 25px; margin-top: 5px;" data-projectId="${project.id}"  data-projectTitle="${project.project}">
                ${customerNameString}${project.project}${amountString}${dateString}
            </div>
        `;

        switch(project.stage) {
            case 'idea':
                $('#projectIdeas').append(cardHtml);
                break;
            case 'discuss':
                $('#projectDiscuss').append(cardHtml);
                break;
            case 'proposal':
                $('#projectProposals').append(cardHtml);
                break;
            case 'feedback':
                $('#projectFeedback').append(cardHtml);
                break;
            case 'won':
                $('#projectClosed').append(cardHtml);
                break;
            default:
                //console.log('Unknown project stage:', project.stage);
        }
    });
}




 // A helper function to keep cell widths consistent while dragging rows
  var fixHelperModified = function(e, tr) {
    var $originals = tr.children();
    var $helper = tr.clone();
    $helper.children().each(function(index) {
      $(this).width($originals.eq(index).width());
    });
    return $helper;
  };

  $("#contactsTableBody").sortable({
    helper: fixHelperModified,
    placeholder: "sortable-placeholder",
    update: function(event, ui) {
      // Update each contact's order in the database based on their new position
      $("#contactsTableBody tr").each(function(index) {
        const contactId = $(this).data('id');
        db.contacts.update(contactId, { order: index })
          .then(updated => {
            if(updated) {
              console.log(`Updated contact ${contactId} order to ${index}`);
            } else {
              console.log(`No changes made or contact ${contactId} not found.`);
            }
          })
          .catch(error => {
            console.error("Failed to update contact order:", error);
          });
      });
    }
  }).disableSelection();






// priority tasks 
	// Query the database for tasks with high priority
let query;
console.log(selectedCustomerId)
if(selectedCustomerId === -1) {
    // If customerId is -1, prepare to query all high priority tasks for all customers
    query = db.tasks.where('priority').equals('High');
	
} else {
    // Otherwise, query high priority tasks for the selected customer
    query = db.tasks.where({ customerId: selectedCustomerId, priority: 'High' });
	
}
query.sortBy('order')
    .then(highPriorityTasks => {
        // After getting tasks, create and append them to the correct container
        appendTaskDivs(highPriorityTasks);
        // Then make these divs sortable across containers
        makeDivsSortable();
    })
    .catch(error => {
        console.error('Failed to load high priority tasks:', error);
    });

// future items load
db.futureItems.where({customerId: selectedCustomerId}).filter(futureItem => futureItem.status !== "Complete").sortBy('order').then(function(futureItems) {
    let cardHtml2 = ''; // Initialize cardHtml outside of the forEach loop
    futureItems.forEach(function(futureItem) {
        console.log("Future item loading", futureItem);
        // For each future item, create a Bootstrap card and append it to cardHtml
        cardHtml2 += `
    <div class="card clickMe futureItemCard mb-3 cardClear item" data-id="${futureItem.id}" 
         style="background-color: transparent; margin-top: 10px; padding: 0px; height: 150px;">
        <div class="card-header custom-header futureItemCard" data-id="${futureItem.id}" 
             style="background-color: white; width: 100%; margin: 0px; padding: 0px;">
            <h6 style="background-color: white;">${futureItem.title}</h6> <!-- Future item title -->
        </div>
        <div class="card-body card-text" style="padding: 5px;">${futureItem.item}</div>
    </div>
`;

    });
	console.log("appending")
    $('#futureItemsDiv').append(cardHtml2); // Append the accumulated cardHtml to a designated div for future items
}).catch(error => {
    console.error("Failed to load future items:", error);
});


	
}//close function 




function formatDateToMMYYYY(inputDate) {
    var date = new Date(inputDate);

    // Get the month and year from the date
    var month = ("0" + (date.getMonth() + 1)).slice(-2); // Adding 1 to get the correct month since months are zero-based
    var year = date.getFullYear();

    // Concatenate the month and year with a hyphen
    var formattedDate = month + '-' + year;
    
    return formattedDate;
}

	
function appendTaskDivs(highPriorityTasks) {
    // Buckets for each stage
    let notStartedBucket = [];
    let inProgressBucket = [];
    let waitingOnOthersBucket = [];

    // Create taskDiv elements and sort them into buckets
    highPriorityTasks.forEach(task => {
        const taskDiv = createTaskDiv(task);

        // Set the data-modified attribute for sorting
        taskDiv.attr('data-modified', task.modified);

        // Add 'urgent-task' class if task is urgent
        if (task.urgent === true) {
            taskDiv.addClass('urgent-task');
        }

        // Sort tasks into buckets based on their stage
        if (task.stage === "Not Started") {
            notStartedBucket.push(taskDiv);
        } else if (task.stage === "In Progress") {
            inProgressBucket.push(taskDiv);
        } else if (task.stage === "Waiting on Others") {
            waitingOnOthersBucket.push(taskDiv);
        }
    });

    // Sort each bucket by the data-modified attribute in descending order
const sortByModifiedDesc = (a, b) => {
    // Check urgent status
    const aUrgent = a.hasClass('urgent-task');
    const bUrgent = b.hasClass('urgent-task');
    
    // Prioritize urgent tasks
    if (aUrgent && !bUrgent) return -1; // 'a' is urgent and 'b' is not, 'a' goes first
    if (!aUrgent && bUrgent) return 1;  // 'b' is urgent and 'a' is not, 'b' goes first

    const aModified = a.attr('data-modified');
    const bModified = b.attr('data-modified');

    // Handle cases where modified dates might be missing
    if (!aModified && !bModified) return 0; // Treat as equal if both lack modified dates
    if (!aModified) return 1;  // Place 'a' after 'b' if missing a modified date
    if (!bModified) return -1; // Place 'b' after 'a' if missing a modified date

    // Compare modified dates for descending order
    return bModified.localeCompare(aModified);
};




    notStartedBucket.sort(sortByModifiedDesc);
    inProgressBucket.sort(sortByModifiedDesc);
    waitingOnOthersBucket.sort(sortByModifiedDesc);

    // Append sorted tasks to their respective stage containers
    notStartedBucket.forEach(taskDiv => $("#notStartedTasksMain").append(taskDiv));
    inProgressBucket.forEach(taskDiv => $("#inprogressTasksMain").append(taskDiv));
    waitingOnOthersBucket.forEach(taskDiv => $("#waitingTasksMain").append(taskDiv));
}

function createTaskDiv(task) {
    // Initialize the base HTML string for the div
	if (task.projectName === "Task"){task.projectName=""}
	//console.log(task.urgent)
   // Set color based on the urgency of the task
    let color = task.urgent ? 'white' : '#7a1dd5';

    let htmlString = '<strong style="color: ' + color + ';">' + task.projectName + '</strong> ' + task.task;

	//console.log(task )
    // Check if customerId is -1 and append customerName if true
	
    if (currentCustomerId === -1) {
	htmlString = '<strong style="color: ' + color + ';">' + 
    (task.customerName === "Select Customer" ? "" : task.customerName) + 
    (task.customerName !== "Select Customer" && task.projectName !== "" ? ' ' : '') + // Add space if customerName is included and projectName is not "Task"
    (task.projectName === "" ? "" : task.projectName) + 
    '</strong> ' + task.task;
    }

    // Create the div with jQuery and set its properties
    return $('<div>')
        .addClass('taskDiv clickMe taskMainView') // Combined addClass and attr for class into one
        .html(htmlString)
        .css({
            'borderRadius': '5px',
            'margin': '5px',
            'padding': '5px',
            'backgroundColor': '#f0f0f0',
            'color': 'black'
        })
        .attr({
            'data-id': task.id, // Using attr for setting data attributes
            'data-stage': task.stage,
            'data-projectName': task.projectName,
            'data-task': task.task,
            'data-comments': task.comments,
            'priority': task.priority,
            'data-urgent': task.urgent,
            'data-modified': task.modified
        })
        .data({
            'projectId': task.projectId,
            'customerId': task.customerId,
            'customerName': task.customerName,
            'dueDate': task.dueDate,
            'taskOwner': task.taskOwner,
            'comments': task.comments,
            'order': task.order,
            
        })
        .draggable({
            connectToSortable: ".sortableContainer",
            helper: "clone",
            revert: "invalid"
        });

}


function makeDivsSortable() {
    $(".sortableContainer").sortable({
        connectWith: ".sortableContainer",
        items: ".taskDiv",
        placeholder: "sortable-placeholder",
        start: function(e, ui) {
            ui.placeholder.height(ui.item.outerHeight());
        },
        update: function(event, ui) {
            if (this === ui.item.parent()[0]) {
                const taskId = ui.item.data('id');
				//console.log(ui.item.parent().attr('id'))
				console.log(taskId)
				var newStage = ""// ******************** need to get he id of the task item to update and then feed that into the updated function ****
				if (ui.item.parent().attr('id') == "notStartedTasksMain"){newStage = "Not Started"} 
				if (ui.item.parent().attr('id') == "inprogressTasksMain"){newStage = "In Progress"} 
				if (ui.item.parent().attr('id') == "waitingTasksMain"){newStage = "Waiting on Others"}              	
				// Update the task stage in IndexedDB
                updateIndexedDB(taskId, 'stage', newStage);
				 setTimeout(() => {
                        loadAndDisplayRelationshipsForSelectedCustomer();
                    }, 500); // 500ms delay
            }
        }
    }).disableSelection();
}



////////////////////////////////////////////////////////////////////////////////
// A. LOAD DISTINCT ACCOUNTS FOR “NEW LOGO” MODAL
////////////////////////////////////////////////////////////////////////////////

function loadNewLogoAccounts() {
  db.newLogoContacts.toArray().then((allRecords) => {
    // 1. Apply the user’s filters
    const accountFilterText = $('#filterAccountInput').val().toLowerCase();
    const stageFilter = $('#filterStageInput').val();
    const sectorFilter = $('#filterSectorInput').val();
    const dxcRevenueFilter = $('#filterDXCRevenueInput').val();
    const onlyFocus = $('#focusProspectSwitch').is(':checked');

    // Map for grouping accounts
    let accountMap = {};

    for (let rec of allRecords) {
      const passAccountName =
        !accountFilterText || rec.accountName.toLowerCase().includes(accountFilterText);
      const passStage = !stageFilter || rec.stage === stageFilter;
      const passSector = !sectorFilter || rec.sector === sectorFilter;
      const passDXC = !dxcRevenueFilter || rec.dxcRevenue === dxcRevenueFilter;
      let thisAccountFocus = !!rec.accountFocus;

      if (!accountMap[rec.accountName]) {
        accountMap[rec.accountName] = {
          accountName: rec.accountName,
          accountFocus: thisAccountFocus,
          matchedContactsCount: 0,
          sector: rec.sector || 'Unknown',
        };
      } else {
        accountMap[rec.accountName].accountFocus =
          accountMap[rec.accountName].accountFocus || thisAccountFocus;
      }

      if (passAccountName && passStage && passSector && passDXC) {
        accountMap[rec.accountName].matchedContactsCount++;
      }
    }

    let filteredAccounts = Object.values(accountMap).filter((a) => a.matchedContactsCount > 0);

    if (onlyFocus) {
      filteredAccounts = filteredAccounts.filter((a) => a.accountFocus === true);
    }

    filteredAccounts.sort((a, b) => a.accountName.localeCompare(b.accountName));

    // 2. Render Accounts
    let html = '';
    filteredAccounts.forEach((a) => {
      let icon = a.accountFocus ? '<i class="fas fa-star" style="color:gold;"></i> ' : '';
      html += `
			<tr class="newLogoAccountItem" data-account="${a.accountName}" style="cursor:pointer; color:white;  font-size: 20px; font-family: Arial, Helvetica, sans-serif;">
				<td style="padding: 8px; vertical-align: middle;">${icon}<strong>${a.accountName}</strong></td>
				<td style="padding: 8px; vertical-align: middle; width: 50%;">${a.sector || ''}</td>
			</tr>
      `;
    });

    $('#newLogoAccountsList').html(html);

   

    // 4. Handle Dropdown Changes
$(document).on('change', '.stage-select', function () {
  const contactId = $(this).data('id');
  const stageValue = $(this).val();

  // Map stage values to their descriptions
  const stageDescriptions = {
    "1": "Prospect Identified",
    "2": "Initial Contact",
    "3": "Meeting Booked",
    "4": "Opportunities Logged",
  };

  const stageDescription = stageDescriptions[stageValue] || '';

  db.newLogoContacts
    .update(contactId, { 
      stageValue: stageValue, 
      stage: stageDescription // Update stage with the text description
    })
    .then((updated) => {
      if (updated) {
        console.log(`Contact ${contactId} updated with stageValue ${stageValue} and stage ${stageDescription}`);
      } else {
        console.error(`Failed to update contact ${contactId}`);
      }
    });
});


    // Hide the “contacts” table if the user picks new filters
    $('#contactsContainer').hide();
    loadSectors();
  });
}
 $('#newLogoTable').hide();
$('#showAccountsButton').hide();

// B. On click of an account, load contacts for that single account
$(document).on('click', '.newLogoAccountItem', function() {
    let accountName = $(this).data('account');
	
    // Hide the account list
    $('#newLogoAccountsList').hide();

    // Show the “contacts” container
    $('#contactsContainer').show();
 $('#newLogoTable').show();
    // Show the “Show Accounts” button
    $('#showAccountsButton').show();

    loadContactsForAccount(accountName);
	$('#filterAccountInput').val('');
		
});

$('#showAccountsButton').on('click', function() {
    // Show the account list
    $('#newLogoAccountsList').show();

    // Hide the contacts container
    $('#contactsContainer').hide();
    $('#newLogoTable').hide();
$('#deleteAccountButton').remove();
    // Hide the “Show Accounts” button again
    $(this).hide();
	 
});

selectedNewLogoAccountName = ""

function loadContactsForAccount(accountName) {
console.log("running loadcontacts"+accountName)
  $('#contactsContainer').show();
  $('#selectedAccountHeading').text(`${accountName}`);
selectedNewLogoAccountName = accountName
console.log(selectedNewLogoAccountName)
ensureNewLogoAccountExists(accountName)
loadAccountDXCFlags(accountName)
  db.newLogoContacts
    .where('accountName')
    .equals(accountName)
    .toArray()
    .then((contacts) => {
      // Filter by contact text
      const contactSearchValue = $('#filterContactInput').val()
        ? $('#filterContactInput').val().toLowerCase()
        : '';
      let filtered = contacts.filter(
        (c) => !contactSearchValue || c.contactName.toLowerCase().includes(contactSearchValue)
      );

      // Sort them by lastInteraction descending
      filtered.sort((a, b) => {
        const dateA = new Date(a.lastInteraction || 0);
        const dateB = new Date(b.lastInteraction || 0);
        return dateB - dateA;
      });

      // Build HTML rows
      let rows = '';
      filtered.forEach((contact) => {
        let dateValue = (contact.lastInteraction || '').split('T')[0];
        let phoneIcon = `<i class="fas fa-phone mr-2" data-field="phone" data-id="${contact.id}"></i>`;
        let emailIcon = `<i class="fas fa-envelope mr-2" data-field="email" data-id="${contact.id}"></i>`;
        let linkedinIcon = `<i class="fab fa-linkedin" data-field="linkedin" data-id="${contact.id}"></i>`;

        // Stage dropdown
        const stageDropdown = `
          <select  style="background-color: transparent; color: white; font-size:18px; border: none; appearance: none; -webkit-appearance: none; -moz-appearance: none; text-align: center;" class="form-control select-colour stage-select" data-id="${contact.id}" style="width: 100%;">
            <option value="">Stage</option>
            <option value="1" ${contact.stageValue == '1' ? 'selected' : ''}>Prospect Identified</option>
            <option value="2" ${contact.stageValue == '2' ? 'selected' : ''}>Initial Contact</option>
            <option value="3" ${contact.stageValue == '3' ? 'selected' : ''}>Meeting Booked</option>
            <option value="4" ${contact.stageValue == '4' ? 'selected' : ''}>Opportunities Logged</option>
          </select>
        `;

        rows += `
          <tr data-id="${contact.id}">
            <td data-newlogoclick="yes"  data-id="${contact.id}" style="width:180px;">${contact.contactName}</td>
            <td style="width:180px;">${contact.jobRole || ''}</td>
            <td style="width:180px;">${stageDropdown}</td>
            <td class="last-interaction">
              <input Style="font-family: 'Roboto', 'Segoe UI', 'Arial', sans-serif; font-size:18px" type="date" class="form-control newLogoLastInteraction" data-id="${contact.id}" value="${dateValue}">
            </td>
            <td Style="font-family: 'Roboto', 'Segoe UI', 'Arial', sans-serif; font-size:20px" class="editable-cell" data-field="notes">${contact.notes || ''}</td>
            <td Style="font-family: 'Roboto', 'Segoe UI', 'Arial', sans-serif; font-size:20px" class="editable-cell" data-field="nextSteps">${contact.nextSteps || ''}</td>
            <td>
              ${phoneIcon}
              ${emailIcon}
              ${linkedinIcon}
            </td>
          </tr>`;
      });

      $('#newLogoTableBody').html(rows);

      // Add the delete button at the end of the contactsContainer
      if (!$('#deleteAccountButton').length) {
	 // $('#newlogodeletebuttonspace').clear()
        $('#newlogodeletebuttonspace').append(`
          <div class="text-end mt-3">
            <button id="deleteAccountButton" class="btn btn-sm btn-danger" style="color: white;">
              Delete Account
            </button>
          </div>
        `);

        // Attach click handler for delete button
        $('#deleteAccountButton').on('click', function () {
          if (confirm(`Are you sure you want to delete the account "${selectedNewLogoAccountName}"?`)) {
            db.newLogoContacts
              .where('accountName')
              .equals(selectedNewLogoAccountName)
              .delete()
              .then(() => {
                alert(`Account "${selectedNewLogoAccountName}" has been deleted.`);
                $('#contactsContainer').hide(); // Hide the container after deletion
                loadNewLogoAccounts(); // Refresh the accounts list
              })
              .catch((error) => {
                console.error("Failed to delete account:", error);
                alert("An error occurred while deleting the account. Please try again.");
              });
          }
        });
      }

      // Handle changes to stage dropdowns
      $(document).on('change', '.stage-select', function () {
        const contactId = $(this).data('id');
        const stageValue = $(this).val();

        // Map stage values to their descriptions
        const stageDescriptions = {
          "1": "Prospect Identified",
          "2": "Initial Contact",
          "3": "Meeting Booked",
          "4": "Opportunities Logged",
        };

        const stageDescription = stageDescriptions[stageValue] || '';

        db.newLogoContacts
          .update(contactId, { 
            stageValue: stageValue, 
            stage: stageDescription // Update stage with the text description
          })
          .then((updated) => {
            if (updated) {
              console.log(`Contact ${contactId} updated with stageValue ${stageValue} and stage ${stageDescription}`);
            } else {
              console.error(`Failed to update contact ${contactId}`);
            }
          });
      });
    });
}


// Listen for changes to "DXC Account?"
$('#dxcAccountSelect').on('change', function() {
  const newValue = $(this).val();
  if (!selectedNewLogoAccountName) return;

  db.newLogoAccounts
    .where('accountName')
    .equals(selectedNewLogoAccountName)
    .first()
    .then(existing => {
      if (existing) {
        // Update existing record
        return db.newLogoAccounts.update(existing.id, {
          dxcAccount: newValue
        });
      } else {
        // Create a new record if one doesn't exist
        return db.newLogoAccounts.add({
          accountName: selectedNewLogoAccountName,
          dxcAccount: newValue,
          dxcEmbeddedAccount: ''
        });
      }
    })
    .catch(err => {
      console.error("Error updating dxcAccount:", err);
    });
	setTimeout(() => {
  applyDropdownColor();
}, 1000);
});

// Listen for changes to "DXC Embedded?"
$('#dxcEmbeddedAccountSelect').on('change', function() {
  const newValue = $(this).val();
  if (!selectedNewLogoAccountName) return;

  db.newLogoAccounts
    .where('accountName')
    .equals(selectedNewLogoAccountName)
    .first()
    .then(existing => {
      if (existing) {
        // Update existing record
        return db.newLogoAccounts.update(existing.id, {
          dxcEmbeddedAccount: newValue
        });
      } else {
        // Create a new record if one doesn't exist
        return db.newLogoAccounts.add({
          accountName: selectedNewLogoAccountName,
          dxcAccount: '',
          dxcEmbeddedAccount: newValue
        });
      }
    })
    .catch(err => {
      console.error("Error updating dxcEmbeddedAccount:", err);
    });
		setTimeout(() => {
  applyDropdownColor();
}, 1000);
});



function ensureNewLogoAccountExists(accountName) {
console.log(accountName) 
 return db.newLogoAccounts
    .where('accountName')
    .equals(accountName)
    .first()
    .then(existing => {
      // If the account does NOT exist, create it
      if (!existing) {
        return db.newLogoAccounts.add({
          accountName: accountName,
          dxcAccount: '',
          dxcEmbeddedAccount: ''
        });
      }
      // If it exists, do nothing
		console.log("already added before")
    })
    .catch(err => {
      console.error("Error ensuring new logo account:", err);
    });
}

function loadAccountDXCFlags(accountName) {
  db.newLogoAccounts
    .where('accountName').equals(accountName)
    .first()
    .then(account => {
      if (account) {
        $('#dxcAccountSelect').val(account.dxcAccount || "");
        $('#dxcEmbeddedAccountSelect').val(account.dxcEmbeddedAccount || "");
      } else {
        $('#dxcAccountSelect').val("");
        $('#dxcEmbeddedAccountSelect').val("");
      }
    })
    .catch(err => console.error(err));
	setTimeout(() => {
  applyDropdownColor();
}, 1000);
}

// C. Re-wire your existing “filter” events to call loadNewLogoAccounts() or loadContactsForAccount(...) as needed
$('#filterAccountInput, #filterStageInput, #filterSectorInput, #filterDXCRevenueInput, #focusProspectSwitch').on('input change', function() {
    loadNewLogoAccounts();
});

// Also re-wire your “contact name” search input (in #contactsContainer)
$('#filterContactInput').on('input', function() {
    // If no account is selected, do nothing:
    let visible = $('#contactsContainer').css('display');
    if (visible === 'none') return;
    // Otherwise, find the currently displayed account name from #selectedAccountHeading
    let headingText = $('#selectedAccountHeading').text();
    // If heading is “Contacts for Account: SomeName”
    let accountName = headingText.replace('Contacts for Account: ', '').trim();
    loadContactsForAccount(accountName);
});

// D. Whenever the “New Logo” modal is shown, we load the accounts list
$('#newLogoModal').on('show.bs.modal', function() {
    loadNewLogoAccounts();
});


function loadSectors() {
console.log("running")
    db.newLogoContacts
        .toArray()
        .then(allRecords => {
            // Extract all sectors from the database
            const sectors = [...new Set(allRecords.map(record => record.sector).filter(Boolean))];
            
            // Sort sectors alphabetically
            sectors.sort((a, b) => a.localeCompare(b));

            // Build the <select> options
            let sectorOptions = `<option value="">All Sectors</option>`;
            sectors.forEach(sector => {
                sectorOptions += `<option value="${sector}">${sector}</option>`;
            });

            // Append options to #filterSectorInput
            $('#filterSectorInput').html(sectorOptions);
        })
        .catch(error => {
            console.error("Error loading sectors:", error);
        });
}



$(document).on('change', '.newLogoDXCRevenueSelect', function() {
    const contactId = parseInt($(this).data('id'));
    const newValue = $(this).val();
    db.newLogoContacts.update(contactId, { dxcRevenue: newValue }).then(() => {
        loadNewLogoAccounts()();
    });
});


// 4) Helpers for dropdown <option> sets
function getSectorOptions(selectedSector) {
    const sectorList = [
      'Technology','Banking','Insurance','Financial Services','Healthcare','Retail',
      'Manufacturing','Telecommunications','Energy','Construction','Transport & Logistics',
      'Education','Hospitality','Media & Entertainment','Public Sector','Other'
    ];
    let html = `<option value="">Select Sector</option>`;
    sectorList.forEach(s => {
       const sel = (s === selectedSector) ? 'selected' : '';
       html += `<option value="${s}" ${sel}>${s}</option>`;
    });
    return html;
}
function getStageOptions(selectedStage) {
    const stages = ['Prospect Identified','Initial Contact','Meeting Booked','Opportunities Logged'];
    let html = `<option value="">Stage</option>`;
    stages.forEach(st => {
      const sel = (st === selectedStage) ? 'selected' : '';
      html += `<option value="${st}" ${sel}>${st}</option>`;
    });
    return html;
}
function getJobRoleOptions(selectedRole) {
    const roles = [
      'CEO','CIO','CFO','IT Director / Head of IT','Service Delivery Manager','IT Operations',
      'Architect','Digital Transformation Leader','Procurement','Platform Owner','Product Owner','Other'
    ];
    let html = `<option value="">Job Role</option>`;
    roles.forEach(r => {
      const sel = (r === selectedRole) ? 'selected' : '';
      html += `<option value="${r}" ${sel}>${r}</option>`;
    });
    return html;
}

// 5) Handle changes for sector, stage, job role
$(document).on('change', '.newLogoSectorSelect', function() {
    const contactId = parseInt($(this).data('id'));
    const newSector = $(this).val();
    db.newLogoContacts.update(contactId, { sector: newSector }).then(() => {
        loadNewLogoAccounts();
    });
});
$(document).on('change', '.newLogoStageSelect', function() {
    const contactId = parseInt($(this).data('id'));
    const newStage = $(this).val();
    db.newLogoContacts.update(contactId, { stage: newStage }).then(() => {
        loadNewLogoAccounts();
    });
});
$(document).on('change', '.newLogoJobRoleSelect', function() {
    const contactId = parseInt($(this).data('id'));
    const newRole = $(this).val();
    db.newLogoContacts.update(contactId, { jobRole: newRole }).then(() => {
        loadNewLogoAccounts();
    });
});

// 6) Handle Last Interaction date changes
$(document).on('change', '.newLogoLastInteraction', function() {
    const contactId = parseInt($(this).data('id'));
    const newDate = $(this).val();
    const isoDate = new Date(newDate).toISOString();
    db.newLogoContacts.update(contactId, { lastInteraction: isoDate }).then(() => {
        loadNewLogoAccounts();
    });
});


// Event handler for when the customer selector changes
$('#customerDropDown').change(function() {
    const val = $(this).val();
    if (val === 'focus') {
        $('#focusModal').modal('show');
        loadFocusModalData();
    } else if (val === 'newLogo') {
        $('#newLogoModal').modal('show');
        loadNewLogoAccounts(); // See function below
    } else {
        loadAndDisplayRelationshipsForSelectedCustomer();
    }
});






// Open the Add Relationship Modal when relationship text is clicked
$('#clickAddRelationship').click(function() {
    $('#addRelationshipModal').modal('show');
});
// Handle the Add Contact Form submission
$('#addRelationshipForm').off('submit').on('submit', function(e) {
    e.preventDefault(); // Prevent default form submission

    // Capture the input values
    const contactName = $('#contactName').val().trim();
    const contactJobRole = $('#contactJobRole').val().trim(); // New field
    const contactEmail = $('#contactEmail').val().trim();
    const contactPhone = $('#contactPhone').val().trim();
    const contactLinkedIn = $('#contactLinkedIn').val().trim();

    // Get the selected customer ID and name
    const customerId = parseInt($('#customerDropDown').val(), 10);
    const customerName = $('#customerDropDown option:selected').text();

    // Save the contact details to IndexedDB with default "Warm" status
    db.contacts.add({
        customerId: customerId,
        customerName: customerName,
        name: contactName,
        jobRole: contactJobRole,
        email: contactEmail || '',
        phone: contactPhone || '',
        linkedIn: contactLinkedIn || '',
        execMapping: '',
        status: 'Warm', // Set default status to Warm
        recentEvents: '',
        plannedEvents: ''
    }).then(() => {
        $('#addRelationshipModal').modal('hide');
        $('#addRelationshipForm')[0].reset();
        loadAndDisplayContactsForSelectedCustomer();
    }).catch(error => {
        console.error("Failed to add contact:", error);
    });
});





// DELETE RELATIONSHIP ITEM
let currentItemId = null; // To store the ID of the item to be deleted

    // Event listener for opening the delete confirmation modal
    $(document).on('click', '.relationshipCard', function() {
	console.log("clicked")
        currentItemId = $(this).data('id'); // Store the item ID
        currentItemIdParse = parseInt(currentItemId); // Store the item ID
        $('#editItemModal').modal('show'); // Show the modal
    });

	// Assuming you have a way to open this modal with the appropriate item data loaded
	$('#editItemModal').on('show.bs.modal', function(event) {
		
		// Use itemId to fetch item data from IndexedDB and populate form fields
		db.relationships.get(currentItemId).then(function(item) {
			$('#editItemTitle').val(item.title);
			$('#editItemContent').val(item.item);
			 $('#editRelationshipItemNotes').summernot
		});
	});

	// Handle the save changes button click
	$('#saveItemChanges').click(function() {
		var itemId = currentItemId;
		var updatedTitle = $('#editItemTitle').val();
		var updatedContent = $('#editItemContent').val();
		var updatedNotes = $('#editRelationshipItemNotes').summernote('code');;

		// Save the updated item back to IndexedDB
		db.relationships.update(itemId, { title: updatedTitle, item: updatedContent, notes: updatedNotes }).then(function(updated) {
			if(updated) {
				// Success logic here, e.g., close modal, refresh UI
				$('#editItemModal').modal('hide');
				loadAndDisplayRelationshipsForSelectedCustomer() 
				console.log("loadAndDisplayRelationshipsForSelectedCustomer")
			} else {
				// Item not found or no changes logic here
			}
		});
	});









// Event listener for changing the relationship item status to "Complete"
$('#deleteItem').on('click', function() {
    var itemId = currentItemId;

    // Update the item status to "Complete" in the IndexedDB
    db.relationships.update(itemId, { status: "Complete" }).then(() => {
        console.log(`Item with ID ${itemId} status updated to Complete.`);
        $('#editItemModal').modal('hide');
        loadAndDisplayRelationshipsForSelectedCustomer(); // Refresh the display to reflect the change
    }).catch(error => {
        console.error("Failed to update item status:", error);
    });
});



  // Make relationship cards sortable
$('#RelationshipItemsDiv').sortable({
    placeholder: "ui-state-highlight",
    update: function(event, ui) {
        $('#RelationshipItemsDiv').children().each(function(index) {
            const id = $(this).data('id');
            const newOrder = index;
            db.relationships.update(id, { order: newOrder }).then(function(updated) {
                if(updated) {
                    console.log(`Updated item ${id} with new order ${newOrder}`);
                } else {
                    console.log(`Failed to update item ${id}`);
                }
            });
        });
    }
});






  // Handle the Add Future Item Form submission
    $('#addFutureItemForm').submit(function(e) {
        e.preventDefault(); // Prevent the default form submission

        const futureItemTitle = $('#futureItemTitle').val(); // Capture the new title field
        const futureItemContent = $('#futureItemContent').val(); // Capture the new item content
        let customerId = $('#customerDropDown').find(':selected').val(); // Assuming a customer dropdown is available
        customerId = parseInt(customerId, 10); // Ensure customerId is an integer

        // Save the future item title, content, and customer ID to IndexedDB
        db.futureItems.add({
            customerId: customerId, 
            title: futureItemTitle, // Including the title in the add operation
            item: futureItemContent
        }).then(() => {
            $('#addFutureItemModal').modal('hide'); // Hide the modal on success
            $('#addFutureItemForm')[0].reset(); // Reset form after submission
            // Optionally, refresh some UI to display the new future item
            // For example, if you have a function to load future items:
           loadAndDisplayRelationshipsForSelectedCustomer()
        }).catch(error => {
            console.error("Failed to add future item:", error);
        });
    });


  // Make relationship cards sortable
$('#futureItemsDiv').sortable({
    placeholder: "ui-state-highlight",
    update: function(event, ui) {
        $('#futureItemsDiv').children().each(function(index) {
            const id = $(this).data('id');
            const newOrder = index;
            db.relationships.update(id, { order: newOrder }).then(function(updated) {
                if(updated) {
                    console.log(`Updated item ${id} with new order ${newOrder}`);
                } else {
                    console.log(`Failed to update item ${id}`);
                }
            });
        });
    }
});



//edit future items

    // Event listener for opening the delete confirmation modal
    $(document).on('click', '.relationshipCard', function() {
	console.log("clicked")
        currentItemId = $(this).data('id'); // Store the item ID
        currentItemIdParse = parseInt(currentItemId); // Store the item ID
        $('#editItemModal').modal('show'); // Show the modal
    });




// Open the Add Project Modal 
$('#addProjectText').click(function() {
    $('#addProjectModal').modal('show');
});


// Handle the Add Project Form submission
 $('#addProjectButton').on('click', function(e) {
    e.preventDefault();
    const projectTitle = $('#projectTitle').val(); // Capture the new title field
    const projectValue = parseInt( $('#projectValue').val() ) ;
    const projectDate = $('#projectDate').val();
    let customerId = $('#customerDropDown').find(':selected').val();
	let customerName1 = $('#customerDropDown').find(':selected').text();

    customerId = parseInt(customerId, 10); // Ensure customerId is an integer

    // Save the relationship title, item, and customer ID to IndexedDB
    db.projects.add({
        customerId: customerId,
		customerName: customerName1,
        project: projectTitle,  
        value: projectValue,
		date: projectDate,
		stage: "idea"
    }).then(() => {
        $('#addProjectModal').modal('hide');
        $('#addProjectForm')[0].reset(); // Reset form after submission
        // Optionally, refresh some UI to show the new relationship
			loadAndDisplayRelationshipsForSelectedCustomer() 
    }).catch(error => {
        console.error("Failed to add relationship item:", error);
    });
});




let currentProjectId = 0
let currentProjectTitle = ""

// Open the Edit Project Modal when relationship text is clicked
    $(document).on('click', '.projectItemCard', function() {
	  var projectId = parseInt ( $(this).attr('data-projectId') );
	  var projectTitle = $(this).attr('data-projectTitle')
	  console.log(projectId, projectTitle )
	  $('#projectModal').data('projectTitle', projectTitle);
	currentProjectId = projectId
	currentProjectTitle = projectTitle
	
	  db.projects.get(projectId, function(project) {
		console.log(project)
		$('#projectNameInput').val(project.project);
		$('#projectValueInput').val(project.value);
		$('#projectDateInput').val(project.date.split('T')[0]); // Assuming date is in ISO format
		$('#projectStageInput').val(project.stage);
		$('#projectModal').data('projectId', projectId); // Store projectId in modal for reference

	  }).catch(error => {
		console.error("Failed to load project:", error);
	  });
	  $('#projectModal').modal('show');

});


	// Handle the save changes button click
// Handle the save changes button click
$('#saveProject').click(function() {
    var projectId = parseInt($('#projectModal').data('projectId'));
    var customerId = parseInt($('#customerDropDown').val()); // Assuming you have a way to get this
    var projectName = $('#projectNameInput').val();
    var value = $('#projectValueInput').val();
    var date = $('#projectDateInput').val(); // Assuming date is in ISO format
    var stage = $('#projectStageInput').val();

    // First, update the project
    db.projects.update(projectId, { project: projectName, value: value, date: date, stage: stage }).then(function(updated) {
        if(updated) {
            // If project update is successful, then update the tasks
            db.tasks.where({ projectId: projectId, customerId: customerId }).modify({ projectName: projectName }).then(() => {
                console.log("Tasks updated with new project name.");
            }).catch(error => {
                console.error("Failed to update tasks with new project name:", error);
            }).finally(() => {
                // Use finally() to ensure loadAndDisplayRelationshipsForSelectedCustomer() runs after all tasks are updated, regardless of success or failure
                setTimeout(loadAndDisplayRelationshipsForSelectedCustomer, 500);
                console.log("Reloading relationships after project and task updates.");
            });

            $('#projectModal').modal('hide'); // Assuming this is the correct logic for hiding the modal
        } else {
            console.log("No changes made or project not found.");
        }
    }).catch(error => {
        console.error("Failed to update project:", error);
    });
});


//show task modal
   $(document).on('click', '#viewTasks', function() {
	$('#taskModal').modal('show');
	$('#projectTitleDiv').text(currentProjectTitle)
	loadTable()   
   })



// add task 

function addTask() {
 const  taskInput = $('#addTaskInput').val().trim(); // Get and trim input value
 if (taskInput === '') {
    console.log('Task input is empty.');
    return; // Exit if input is empty
  }
 // Define the new task object
  const newTask = {
    projectId: currentProjectId,
    projectName: currentProjectTitle,
    customerId: currentCustomerId,
    customerName: currentCustomerName,
    task: taskInput,
    stage: 'Not Started', // Assuming default stage
    dueDate: '', // Assuming dueDate is optional or can be set later
    taskOwner: '', // Assuming taskOwner can be set later
    comments: '' // Assuming comments can be added later
  };
 db.tasks.add(newTask).then(() => {
    console.log('New task added:', newTask);
    $('#addTaskInput').val(''); // Clear the input field
    loadTable(); // Call loadTable function to refresh the tasks table
  }).catch((error) => {
    console.error('Failed to add new task:', error);
  });
}

$('#addTaskInput').on('keypress', function(e) {
  if (e.which === 13) { // 13 is the Enter key
    addTask(); // Call the function to add the task
  }
});

function loadTable() {
  $('#projectTableBody').empty(); // Clear existing rows
  // Query the database for tasks, sorted by the 'order' field
  db.tasks.where({ projectId: currentProjectId }).filter(task => task.stage !== 'Discontinued')
    .sortBy('order') // Assuming 'order' is a numeric field indicating the task order
    .then(tasks => {
      tasks.forEach(task => {
		  let bgcolor = "";
switch(task.stage) {
    case 'Complete':
        bgcolor = '#baffc9';
        break;
    case 'Waiting on Others':
        bgcolor = '#b9f3ff';
        break;
    case 'In Progress':
        bgcolor = '#ffdfb9';
        break;
    case 'Not Started':
        bgcolor = '#ffb3ba';
        break;
    default:
        bgcolor = ''; // Default case if needed
}

        // Construct a row for each task
const row = `<tr data-task-id="${task.id}" class="vertical-center task-row">
  <td style="text-align: left !important;" data-task-id="${task.id}" data-cell-type="task" class="editable vertical-center  project-Row">${task.task}</td>
  <td data-task-id="${task.id}" data-cell-type="stage">
    <select style="background-color: rgba(0, 0, 0, 0.0); background-color:${bgcolor};" class="form-control close-table-status-select" data-id="${task.id}">
      <option value="" disabled>Select Status</option>
      <option value="Not Started" ${task.stage === "Not Started" ? "selected" : ""}>Not Started</option>
      <option value="In Progress" ${task.stage === "In Progress" ? "selected" : ""}>In Progress</option>
      <option value="Waiting on Others" ${task.stage === "Waiting on Others" ? "selected" : ""}>Waiting on Others</option>
      <option value="Complete" ${task.stage === "Complete" ? "selected" : ""}>Complete</option>
      <option value="Discontinued" ${task.stage === "Discontinued" ? "selected" : ""}>Discontinued</option>
    </select>
  </td>
  <td data-task-id="${task.id}" data-cell-type="dueDate">
    <div class="form-group">
      <input data-task-id="${task.id}" data-cell-type="dueDate" type="date" class="form-control due-date-input" value="${task.dueDate}">
    </div>
  </td>
  <td class="editable vertical-center project-Row" data-task-id="${task.id}" data-cell-type="taskOwner">${task.taskOwner}</td>
  <td  style="text-align: left !important;" class="editable vertical-center project-Row" data-task-id="${task.id}" data-cell-type="comments">${task.comments}</td>
  <td class="priority-toggle-cell">
    <div class="form-check form-switch priority-toggle">
      <input class="form-check-input" type="checkbox" id="priorityToggle${task.id}"
             data-task-id="${task.id}" ${task.priority === 'High' ? 'checked' : ''}>
      <label class="form-check-label" for="priorityToggle${task.id}"></label>
    </div>
  </td>
</tr>`;


        // Append the row to the table body
        $('#projectTableBody').append(row);
      });

      // Re-initialize or refresh sortable if necessary
      makeTableSortable();
    }).catch(error => {
      console.error('Failed to load tasks:', error);
    });
}



   // Listen for changes on any dropdown with the class close-table-status-select
  $(document).on('change', '.close-table-status-select', function() {
        var taskId = $(this).data('id'); // Assuming data-id holds the task ID
        var newStatus = $(this).val(); // The new value selected from the dropdown

        // Use the existing function to update the task's stage/status in IndexedDB
        updateIndexedDB(taskId, 'stage', newStatus); // Assuming 'stage' is the column name for task status
		
    });


function updateTaskOrder() {
  // Fetch all tasks as they're currently ordered in the UI
  const orderedTasks = $('#projectTableBody tr').toArray().map((row, index) => ({
    id: $(row).data('taskId'), // Assuming you add a data-task-id attribute to your rows
    order: index
  }));

  // Update each task's order in the database
  console.log(orderedTasks)
  orderedTasks.forEach(task => {
    db.tasks.update(task.id, { order: task.order }).catch(error => {
      console.error(`Failed to update order for task ${task.id}:`, error);
    });
  });
}

function makeTableSortable() {
  $("#projectTableBody").sortable({
    items: 'tr',
    cursor: 'move',
    opacity: 0.6,
    update: function() {
      updateTaskOrder();
    }
  }).disableSelection();
}


// Pressing enter in the add task input triggers the save button
$('#newFocusTaskInput').on('keypress', function(e) {
    if (e.which === 13) {
        $('#saveFocusTaskButton').click();
    }
});

$('#saveFocusTaskButton').click(function() {
    const taskInput = $('#newFocusTaskInput').val().trim();
    if (!taskInput) return;

    let newTask = {
        projectName: 'Task',
        customerId: -1,       // or any ID you prefer for "Focus" tasks
        customerName: 'Focus',
        task: taskInput,
        stage: 'Not Started',
        dueDate: '',
        taskOwner: '',
        comments: '',
        priority: 'High',
        focus: true
    };

    db.tasks.add(newTask).then(() => {
        $('#newFocusTaskInput').val('');
        loadFocusModalData();
    }).catch(error => {
        console.error('Failed to add new focus task:', error);
    });
});


//hide task modal 
$('#hideTaskModal').click(function() {
	 $('#projectModal').modal('hide');
	 loadAndDisplayRelationshipsForSelectedCustomer()
	});



/*
$(document).on('click', '.editable.project-Row', function() {
console.log("running 2509 function ")
  var currentElement = $(this);
  var taskId = $(this).attr('data-task-id'); // Ensure rows have data-task-id attributes
  var columnName = $(this).attr('data-cell-type'); // Ensure cells have data-column-name attributes 
  var value = $(this).val();
  var origionalText = $(this).text()
  console.log(origionalText)
  var inputField = $('<input>', {
    'type': 'text',
    'value': origionalText,
	  'class': 'form-control',
    'click': function(event) {
      event.stopPropagation(); // Prevent the click from propagating to the .editable
    },
    'blur': function() {
      var newValue = $(this).val();
      currentElement.html(newValue);

      // Call the function to update IndexedDB here, passing the row's ID, column name, and new value
    
		console.log(taskId, columnName)
	 updateIndexedDB(taskId, columnName, newValue);
    },
    'keypress': function(e) {
      if (e.which == 13) { // Enter key pressed
        $(this).blur();
      }
    }
  }).appendTo(currentElement.empty()).focus();
});
*/

$(document).on('click', '.editable.project-Row', function() {
    var cell = $(this);
    var taskId = cell.attr('data-task-id');
    var columnName = cell.attr('data-cell-type');
    var originalText = cell.text().trim();

    // Avoid placing a second textarea if user double-clicks quickly
    if (cell.find('textarea').length > 0) {
        return;
    }

    // Create a <textarea> containing the original text
    var textArea = $('<textarea>')
        .addClass('form-control')
        .val(originalText);

    // Clear the cell's content, then insert the <textarea>
    cell.empty().append(textArea);

    // Auto-resize on input
    textArea.on('input', function() {
        autoGrow(this);
    });

    // Kick off one auto-grow so the initial size matches existing text
    autoGrow(textArea[0]);

    // Handle key presses
    textArea.on('keypress', function(e) {
        if (e.which === 13) {  // Enter key
            if (e.shiftKey || e.altKey) {
                // Insert a newline (don't finalize)
                e.preventDefault();
                insertNewLineAtCursor(this);
            } else {
                // Plain Enter => finalize/save
                e.preventDefault();
                finalizeEdit(this);
            }
        }
    });

    // Also save on blur if user just clicks away
    textArea.on('blur', function() {
        finalizeEdit(this);
    });

    function finalizeEdit(textareaEl) {
        var newValue = $(textareaEl).val();
        // Put the final text back in the cell (with newlines)
        cell.text(newValue);

        // Persist to IndexedDB (or wherever you're storing)
        updateIndexedDB(taskId, columnName, newValue);
    }
});

// Helper function to auto-grow the textarea
function autoGrow(textarea) {
    textarea.style.height = 'auto';   // Reset the height
    textarea.style.height = textarea.scrollHeight + 'px'; // Set it to the scroll size
}

// Helper function for inserting a real "\n" at the cursor
function insertNewLineAtCursor(textarea) {
    var start = textarea.selectionStart;
    var end = textarea.selectionEnd;
    var text = textarea.value;
    textarea.value = text.substring(0, start) + "\n" + text.substring(end);
    textarea.selectionStart = textarea.selectionEnd = start + 1;
}



//update tasks
function updateIndexedDB(taskId, columnName, newValue) {
  var id = parseInt(taskId); // Assuming taskId is always an integer
console.log(taskId, columnName, newValue) 
 db.tasks.get(id).then(function(task) {
    if(task) {
      task[columnName] = newValue; // Update the field in the task object
      db.tasks.put(task).then(function() {
        console.log(`Task ${taskId} updated: ${columnName} = ${newValue}`);
		loadTable()
		//loadAndDisplayRelationshipsForSelectedCustomer()
      }).catch(function(error) {
        console.error('Failed to update task:', error);
      });
    }
  });
}

$(document).on('change', '.due-date-input', function() {
  var taskId = $(this).data('task-id'); // Get the task ID
  var newDate = $(this).val(); // Get the new date value
console.log("updating due date")
  updateIndexedDB(taskId, 'dueDate', newDate); // Call the update function

});


//complete task from main view 
// Attach click event listener to the element with ID 'deleteItemPriorityTask'
$('#deleteItemPriorityTask').on('click', function() {
    var taskId = taskMainCurrentSelectedId;
    updateIndexedDB(taskId, 'stage', 'Complete'); // No .then() currently, as per the workaround

    // Hide the edit task modal
    $('#editTaskModal').modal('hide');

    if ($('#focusModal').hasClass('show')) {
        // Refresh the tasks in the focus modal
        loadFocusModalData();

        // Attempt to re-show the focus modal to restore proper scrolling
       // $('#focusModal').modal('show');
	

        // Give a small timeout to ensure the modal is fully re-initialised before focusing
        setTimeout(() => {
            // Focus on the new task input field inside the focus modal
            $('#newFocusTaskInput').focus();
        }, 100);
    } else {
        // Focus modal not open, proceed with normal refresh
        loadAndDisplayRelationshipsForSelectedCustomer();
    }
});



      // Event listener for when the modal is hidden
      $('#focusModal').on('hidden.bs.modal', function () {
        $('#customerDropDown').val('-1'); // Reset the dropdown to value -1
      });



//task priority
 let hoverTimeout;

  $('.task-row').hover(function() {
    clearTimeout(hoverTimeout);
    $(this).find('.priority-toggle').css('visibility', 'visible');
  }, function() {
    // Start a timeout when not hovering
    const toggle = $(this).find('.priority-toggle');
    hoverTimeout = setTimeout(() => {
      toggle.css('visibility', 'hidden');
    }, 2000); // Hide after 2 seconds
  });

  // Listen for changes on the priority toggle
  $(document).on('change', '.priority-toggle input', function() {
    const taskId = $(this).data('task-id');
    const newPriority = $(this).is(':checked') ? 'High' : 'None';

    // Call your function to update IndexedDB
    updateIndexedDB(taskId, 'priority', newPriority);
  });



let  currentFutureItemId = ""
let currentFutureItemIdParse = 0
//show future modal 
 $('#futureItemAddHere').click(function() {
        $('#addFutureItemModal').modal('show');
		
    });


    $(document).on('click', '.futureItemCard', function() {
	console.log("clicked")
	$('#editFutureItemTitle').val('');
	$('#editFutureItemContent').val('');
	$('#editFutureItemNotes').summernote('code', '');
        currentFutureItemId = $(this).data('id'); // Store the item ID
        currentFutureItemIdParse = parseInt(currentFutureItemId); // Store the item ID
				// Use itemId to fetch item data from IndexedDB and populate form fields
		db.futureItems.get(currentFutureItemIdParse).then(function(item) {
			$('#editFutureItemTitle').val(item.title);
			$('#editFutureItemContent').val(item.item);
			 $('#editFutureItemNotes').summernote('code', item.notes);
		});
        $('#editFutureItemModal').modal('show'); // Show the modal
		
    });


// Handle the save changes button click for future items
$('#saveFutureItemChanges').click(function() {
    var itemId = currentFutureItemIdParse; // Assuming currentItemId is set when an item is selected for editing
    var updatedTitle = $('#editFutureItemTitle').val(); // Ensure these IDs match your form fields
    var updatedContent = $('#editFutureItemContent').val();
    var updatedNotes = $('#editFutureItemNotes').summernote('code'); // Retrieve the HTML content from Summernote

    // Save the updated item back to IndexedDB under futureItems table, including the notes
    db.futureItems.update(itemId, { title: updatedTitle, item: updatedContent, notes: updatedNotes }).then(function(updated) {
        if(updated) {
            // Success logic here, e.g., close modal, refresh UI
            $('#editFutureItemModal').modal('hide');
            console.log("Refresh UI to reflect the changes");
            // Function to refresh the displayed future items
            loadAndDisplayRelationshipsForSelectedCustomer();
        } else {
            // Item not found or no changes logic here
            console.log("No changes made or item not found");
        }
    }).catch(function(error) {
        console.error("Failed to update item:", error);
    });
});


// Event listener for the delete future item button
$('#deleteFutureItem').on('click', function() {
    var itemId2 = currentFutureItemIdParse; // Assuming currentFutureItemIdParse is set when an item is selected

    // Update the future item's status to "Complete" in the IndexedDB
    db.futureItems.update(itemId2, { status: "Complete" }).then((updated) => {
        if(updated) {
            console.log(`Future item with ID ${itemId2} status updated to Complete.`);
            $('#editFutureItemModal').modal('hide');
            loadAndDisplayRelationshipsForSelectedCustomer(); // Refresh the displayed items to reflect the change
        } else {
            console.log("No item was updated - it may not exist or the status was already 'Complete'.");
        }
    }).catch(error => {
        console.error("Failed to update future item status:", error);
    });
});





  // Make future cards sortable
$('#futureItemsDiv').sortable({
    placeholder: "ui-state-highlight",
    update: function(event, ui) {
        $('#futureItemsDiv').children().each(function(index) {
            const id = $(this).data('id');
            const newOrder = index;
            db.futureItems.update(id, { order: newOrder }).then(function(updated) {
                if(updated) {
                    console.log(`Updated item ${id} with new order ${newOrder}`);
                } else {
                    console.log(`Failed to update item ${id}`);
                }
            });
        });
    }
});


let taskMainCurrentSelectedId = 0

// Open the edit main view task  Modal is clicked
$(document).on('click', '.taskMainView', function() {
    // Extract data from the clicked element
    var task = $(this).data('task');
    var comments = $(this).data('comments');
    var priority = $(this).attr('priority') //.data('priority'); // Assuming there's a data-priority attribute
    taskMainCurrentSelectedId = parseInt($(this).data('id'));
    console.log(task);

    // Set the extracted data to the modal's fields
    $('#editTaskField').val(task);
    $('#editTaskComments').val(comments);

    // Check if the priority is high and update the checkbox
	console.log(priority)
    if (priority === 'High') {
        $('#editTaskPriority').prop('checked', true);
    } else {
        $('#editTaskPriority').prop('checked', false);
    }

    // Show the modal
    $('#editTaskModal').modal('show');
});



  let hideTimeout;

  $('#newLogoContactAddButton').on('mouseover', function() {
    $('#newLogoAddContactForm').addClass('show-inputs');
    clearTimeout(hideTimeout);
    hideTimeout = setTimeout(() => {
      $('#newLogoAddContactForm').removeClass('show-inputs');
    }, 30000);
  });



$('#newLogoAddContactForm').on('submit', function (e) {
  e.preventDefault();
  clearTimeout(hideTimeout);

  const contactName = $('#newLogoContactNameInput').val().trim();
  const accountName = $('#newLogoAccountInput').val().trim();
  const sector = $('#newLogoSectorInput').val();
  const stage = $('#newLogoStageInput').text();
  const stageVal = $('#newLogoStageInput').val();
  const jobRole = $('#newLogoJobRoleInput').val();

  // Basic validation checks
  if (!contactName) {
    alert("Please enter a contact name.");
    return;
  }
  if (!accountName) {
    alert("Please enter an account name.");
    return;
  }
  if (!sector) {
    alert("Please select a sector.");
    return;
  }
  if (!stage) {
    alert("Please select a stage.");
    return;
  }
  if (!jobRole) {
    alert("Please select a job role.");
    return;
  }

  // Check for matching accountName and accountFocus status
  db.newLogoContacts
    .where("accountName")
    .equalsIgnoreCase(accountName)
    .toArray()
    .then((contacts) => {
      // Determine accountFocus for the new contact
      const hasAccountFocus = contacts.some((contact) => contact.accountFocus);

      // Add the new contact with the determined accountFocus status
      return db.newLogoContacts.add({
        accountName: accountName,
        contactName: contactName,
        sector: sector,
        stage: stage,
		stageValue: stageVal,
        jobRole: jobRole,
        lastInteraction: '',
        notes: '',
        nextSteps: '',
        phone: '',
        email: '',
        linkedin: '',
        dxcRevenue: '',
        accountFocus: hasAccountFocus, // Set based on other contacts
      });
    })
    .then(() => {
      // Reset the form after a successful addition
      $('#newLogoAddContactForm')[0].reset();
      // Refresh the new logo contacts table
      loadNewLogoAccounts();
    })
    .catch((error) => {
      console.error("Failed to add new logo contact:", error);
      alert("An error occurred while adding the contact. Please try again.");
    });
});





// Save the edit main view task when the Save button is clicked
$(document).on('click', '#saveTaskChanges', function() {
  updateTaskInfo()
});

function updateTaskInfo() {
    var updatedTask = $('#editTaskField').val();
    var updatedComments = $('#editTaskComments').val();
    var priority = $('#editTaskPriority').is(':checked') ? 'High' : '';
    var taskId = parseInt(taskMainCurrentSelectedId, 10);

    // Hide the edit task modal
    $('#editTaskModal').modal('hide');

    // Update the task in the database
    db.tasks.update(taskId, {
        task: updatedTask,
        comments: updatedComments,
        priority: priority
    })
    .then(function(updateCount) {
        if (updateCount) {
            console.log(`Task ${taskId} updated.`);
            loadAndDisplayRelationshipsForSelectedCustomer();
        } else {
            console.log("No task was updated. It might not exist or the new values were the same as the old values.");
        }
    })
    .catch(function(error) {
        console.error('Failed to update task:', error);
    })
    .finally(function() {
        // After finishing .then() or .catch(), do the timed dropdown changes
        setTimeout(function() {
            // 1) Set to Select Customer after 0.1s
            $('#customerDropDown').val('-1').trigger('change');

            setTimeout(function() {
                // 2) Then set to Focus after another 0.3s
                $('#customerDropDown').val('focus').trigger('change');
            }, 300);

        }, 10);
    });
}




//save the task if click outside the modal
//$('#editTaskModal').on('hidden.bs.modal', function () {
 //  updateTaskInfo()
//});



// Complete the task when the Complete button is clicked
$(document).on('click', '#completeTasks', function() {
    updateIndexedDB(taskMainCurrentSelectedId, 'stage', 'complete');
});




// add task not connected to a project
$(document).on('click', '#clickAddTasksNoProject', function() {
    // Show the modal
    $('#addTaskModal').modal('show');
});
$('#addTaskModal').on('shown.bs.modal', function () {
    $('#newTaskField').focus();
});

$('#newTaskField').on('keypress', function(e) {
    if (e.which === 13) {
        $('#saveNewTask').click();
    }
});

$(document).on('click', '#saveNewTask', function() {
 var  taskInput = $('#newTaskField').val().trim(); // Get and trim input value
 var taskCommentsInput = $('#newTaskComments').val()
 if (taskInput === '') {
    console.log('Task input is empty.');
	 $('#newTaskField').val('')
	$('#newTaskComments').val('')
    return; // Exit if input is empty
  }
 // Define the new task object
  var newTask = {
    projectName:'Task',
	customerId: currentCustomerId,
    customerName: currentCustomerName,
    task: taskInput,
    stage: 'Not Started', // Assuming default stage
    dueDate: '', // Assuming dueDate is optional or can be set later
    taskOwner: '', // Assuming taskOwner can be set later
    comments: taskCommentsInput,
	priority: 'High'
  };
 db.tasks.add(newTask).then(() => {
    console.log('New task added:', newTask);
	$('#newTaskField').val('')
	$('#newTaskComments').val('')
	
    loadAndDisplayRelationshipsForSelectedCustomer()// Call loadTable function to refresh the tasks table
  }).catch((error) => {
    console.error('Failed to add new task:', error);
  });
})



let currentNotesCustomerId = 0

var backgrounds = ['background.png', 'bg2.png', 'bg3.png']; // Array holding the background images
var currentBackgroundIndex = 0; // Variable to track the current index of the backgrounds array

$('#selectedCustomerDiv').on('contextmenu', function(event) {
    event.preventDefault(); // Prevents the default context menu

    // Cycle through the backgrounds array
    currentBackgroundIndex = (currentBackgroundIndex + 1) % backgrounds.length;

    // Set the new background image
    var newBackground = backgrounds[currentBackgroundIndex];
    $('#backgroundContainer').css('background-image', 'url(' + newBackground + ')');

    // Check if the new background is bg3.jpg and apply a filter
    if (newBackground === 'bg3.png') {
        $('#backgroundContainer').css('filter', 'brightness(70%)');
    } else {
        $('#backgroundContainer').css('filter', 'brightness(100%)');
    }
    if (newBackground === 'bg2.png') {
        $('#backgroundContainer').css('filter', 'brightness(80%)');
    } else {
        $('#backgroundContainer').css('filter', 'brightness(100%)');
    }
    return false; // Prevent the default context menu
});


	
$('#selectedCustomerDiv').click(function() {
    currentNotesCustomerId = parseInt($('#customerDropDown').val(), 10); // Assuming this correctly retrieves the current customer ID from your dropdown
    $('#textEditorModal').modal('show');

    db.notes.get(currentNotesCustomerId).then(note => {
        if(note) {
            // If a note exists, set the content of the Summernote editor
            $('#textEditor').summernote('code', note.notes);
        } else {
            // If there is no note, set the content to an empty string
            $('#textEditor').summernote('code', '');
        }
    }).catch(error => {
        console.error("Failed to load note", error);
        // Ensure the editor is cleared if there's an error
        $('#textEditor').summernote('code', '');
    });
});



 // Initialize Summernote
  $('#textEditorProject').summernote({
    height: 700,   // set editor height
    minHeight: null, // set minimum height of editor
    maxHeight: null, // set maximum height of editor
    focus: true,    // set focus to editable area after initializing summernote
   
  });



 // Initialize Summernote
  $('#textEditor').summernote({
    height: 700,   // set editor height
    minHeight: null, // set minimum height of editor
    maxHeight: null, // set maximum height of editor
    focus: true,    // set focus to editable area after initializing summernote
   
  });


  // Function to save or update notes in the database
 function saveOrUpdateNotes(customerId, notesContent) {
        db.notes.put({
            id: customerId, // Use customerId as the ID for uniqueness
            customerId: customerId,
            notes: notesContent
        }).then(() => {
            console.log("Notes saved or updated successfully");
        }).catch((error) => {
            console.error("Failed to save or update notes", error);
        });
    }

    $('#textEditor').on('summernote.change', function(we, contents, $editable) {
        saveOrUpdateNotes(currentNotesCustomerId, contents);
    });
	


// Function to save or update project notes in the database
function saveOrUpdateProjectNotes(projectId, notesContent) {
    db.projectnotes.put({
        projectId: projectId, // Use projectId to identify the note
        notes: notesContent,
        modified: new Date() // Assuming you're tracking modification times
    }).then(() => {
        console.log("Project notes saved or updated successfully");
    }).catch((error) => {
        console.error("Failed to save or update project notes", error);
    });
}

$('#textEditorProject').on('summernote.change', function(we, contents, $editable) {
    // Assuming currentProjectId is set to the ID of the project being edited
    saveOrUpdateProjectNotes(currentProjectId, contents);
});


document.querySelector("#addProjectModal").addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
        event.preventDefault();
        document.querySelector("#addProjectButton").click();
    }
});
document.querySelector("#addTaskModal").addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
        event.preventDefault();
        document.querySelector("#saveNewTask").click();
    }
});
document.querySelector("#editTaskModal").addEventListener("keydown", function (event) {
    if (event.key === "Enter" && document.activeElement.id === "editTaskField") {
        event.preventDefault();
        document.querySelector("#saveTaskChanges").click();
    }
});



// Listen for the keypress event on the specified inputs
$('#projectTitle, #projectValue, #projectDate').keypress(function(e) {
    // Check if the key pressed is the Enter key
    if(e.which == 13) {
        e.preventDefault(); // Prevent the default action (form submission)
        $('#addProjectButton').click(); // Trigger the click event of the addProjectButton
    }
});



$('#projectModal').on('shown.bs.modal', function () {
    $('#viewTasks').click(); // Assuming viewTasks is the ID of the button you want to "click"
});





 $('#editFutureItemNotes').summernote({
        placeholder: 'Enter notes here...',
        tabsize: 2,
        height: 130,
        toolbar: [
            // Each group is an array of button lists
            ['style', ['bold', 'italic', 'underline', 'clear']],
            ['para', ['ul', 'ol']],
        ]
    });
 $('#editRelationshipItemNotes').summernote({
        placeholder: 'Enter notes here...',
        tabsize: 2,
        height: 130,
        toolbar: [
            // Each group is an array of button lists
            ['style', ['bold', 'italic', 'underline', 'clear']],
            ['para', ['ul', 'ol']],
        ]
    });

//mindmapDiv1




//load mind map modal
$('#openMindMap').on('click', function() {
    $('#mindmapDiv').empty();
    $('#mindMapModal').modal('show');
    $('#textEditorModal').modal('hide');
	
	 setTimeout(loadMindMap, 2000);
});

  







$('#projectModal').on('hidden.bs.modal', function () {
	loadAndDisplayRelationshipsForSelectedCustomer()
});




// focus on customer drop down when i press a key to avoid needing to use the mouse to swithc betwene customers 
$(document).on('keydown', function(event) {
    // Check if any modals are currently shown
    if ($('.modal:visible').length === 0) {
        // Check if the pressed key is Escape
        if (event.key === "Escape" || event.keyCode === 27) {
            var dropdown = $('#customerDropDown'); // Select the dropdown
            dropdown.val(dropdown.find('option').first().val()).trigger('change'); // Set dropdown value to the first option and trigger change event
            dropdown.focus(); // Focus the dropdown
            event.preventDefault(); // Prevent the default action for the Escape key
        } else if (!$(document.activeElement).is("input, textarea, select")) {
            // Your existing logic for other keys
            var key = String.fromCharCode(event.which).toLowerCase(); // Convert key to lowercase
            var dropdown = $('#customerDropDown'); // Select the dropdown
            var options = dropdown.find('option'); // Find all option elements
            
            var matchingOptionFound = false;

            options.each(function() {
                var optionText = $(this).text().trim().toLowerCase(); // Get option text and convert to lowercase
                if (optionText.startsWith(key) && !matchingOptionFound) { // Check if option starts with pressed key
                    dropdown.val($(this).val()).trigger('change'); // Set dropdown value and trigger change event
                    matchingOptionFound = true; // Prevent selecting multiple matches
                }
            });

            if (matchingOptionFound) {
                dropdown.focus(); // Optionally focus the dropdown if a match was found
            }
        }
    }
});





//options button
  $('#optionsButton').click(function() {
        $('#optionsModal').modal('show');
    });







 $('#opportunitiesTimelineViewButton').click(function() {
        // Hide any currently shown modals
		$('#optionsModal').modal('hide');
            $('#timelineViewModal').modal('show');
    
});




async function fetchProjectsAndTasks() {
    const projects = await db.projects
  .filter(project => !["won", "lost", "discontinued", "idea"].includes(project.stage) && project.customerId > 0)
  .toArray();
    const projectData = await Promise.all(projects.map(async project => {
        const tasks = await db.tasks.where('projectId').equals(project.id).toArray();
        // Create a date representing 30 days in the past
        let thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        // Ensure a valid date; use project's modified, 30 days ago, or current date as fallback
        const lastModified = tasks.reduce((max, task) => new Date(task.modified).valueOf() > new Date(max).valueOf() ? task.modified : max, project.modified || thirtyDaysAgo.toISOString());
        
        return { id: project.id, content: project.project, start: lastModified, customerName:project.customerName };
    }));

    // Debugging: Log any project with invalid date
    projectData.forEach(project => {
        if (!new Date(project.start).valueOf()) {
            console.log('Invalid date for project:', project);
        }
    });

    return projectData;
}


function renderTimeline(projectData) {
	   // Clear the visualization container
    const container1 = document.getElementById('visualization');
    container1.innerHTML = ''; // This line clears the container
    // Transform project data to include custom HTML content with data-projectid attribute
    const transformedProjectData = projectData.map(project => ({
        id: project.id,
        content: `<div  data-projecttitle="${project.content}" data-projectid="${project.id}">${project.customerName} ${project.content}</div>`,
        start: project.start,
    }));

    const items = new vis.DataSet(transformedProjectData);
    const container = document.getElementById('visualization');

    // Determine the minimum and maximum dates
    let minDate = new Date(Math.min(...transformedProjectData.map(item => new Date(item.start))));
    let maxDate = new Date(Math.max(...transformedProjectData.map(item => new Date(item.start))));
    minDate.setDate(minDate.getDate() - 1);
    maxDate.setDate(maxDate.getDate() + 1);

    const options = {
        width: '100%',
        height: '700px',
        start: minDate,
        end: maxDate,
        margin: {
            item: 10,
            axis: 5
        },
        horizontalScroll: true,
        zoomKey: 'ctrlKey',
        template: function(item, element, data) {
            return data.content; // Use the custom HTML content with data-projectid
        },
        format: {
            minorLabels: {
                millisecond: 'SSS',
                second: 's',
                minute: 'HH:mm',
                hour: 'HH:mm',
                weekday: 'ddd D',
                day: 'D',
                week: 'w',
                month: 'MMM',
                year: 'YYYY'
            },
            majorLabels: {
                millisecond: 'HH:mm:ss',
                second: 'D MMMM HH:mm',
                minute: 'ddd D MMMM',
                hour: 'ddd D MMMM',
                weekday: 'MMMM YYYY',
                day: 'MMMM YYYY',
                week: 'MMMM YYYY',
                month: 'YYYY',
                year: 'YYYY'
            }
        }
    };

    var timeline = new vis.Timeline(container, items, options);
    timeline.fit();

    // Add click listener to log projectId of clicked item
    timeline.on('click', function(properties) {
        if (properties.item) {
            const clickedItem = items.get(properties.item);
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(clickedItem.content, 'text/html');
            const projectId = htmlDoc.querySelector('div').getAttribute('data-projectid');
            const projectTitle1 = htmlDoc.querySelector('div').getAttribute('data-projecttitle');
            console.log('Clicked projectId:', projectId);
			currentProjectId = parseInt(projectId)
			 currentProjectTitle = projectTitle1
			 $('#viewTasks').click(); 
        }
    });
}




async function initTimelineView() {
    const projectData = await fetchProjectsAndTasks();
    renderTimeline(projectData);
	console.log("running time line")
}

$('#timelineViewModal').on('shown.bs.modal', function () {
    // Ensure the modal is visible before rendering the timeline
    initTimelineView(); // Call the function that initializes the timeline
});


 $('#taskModal').on('show.bs.modal', function () {
        // Set taskModal z-index higher than timelineViewModal
        $(this).css('z-index', '1060');
    });

    $('#taskModal').on('hidden.bs.modal', function () {
        // Reset z-index when taskModal is hidden (optional)
        $(this).css('z-index', '');
		      if ($('#timelineViewModal').hasClass('show')) {
				initTimelineView(); // Re-initialize or update the timeline view
			}
    });




// make task urgent
$(document).on('contextmenu', '.taskMainView', async function(event) {
    event.preventDefault(); // Prevent the default context menu from showing

    // Extract the task ID from the clicked element
    const taskId = parseInt($(this).data('id'));

    try {
        // Retrieve the current task to find out its "urgent" status
        const task = await db.tasks.get(taskId);
        if (task) {
            // Toggle the "urgent" status
            const newUrgentStatus = !task.urgent;

            // Update the task in IndexedDB with the new "urgent" status
            await db.tasks.update(taskId, { urgent: newUrgentStatus });
            console.log(`Task ${taskId} urgent status updated to ${newUrgentStatus}.`);

            // Call the function to update the UI after the DB update is successful
            loadAndDisplayRelationshipsForSelectedCustomer();

        } else {
            console.error(`Task ${taskId} not found.`);
        }
    } catch (error) {
        console.error(`Failed to toggle urgent status for task ${taskId}:`, error);
    }
});




function applyDropdownColor() {
  // 1) DXC Account Select
  console.log("running color change")
  const $dxcAccount = $('#dxcAccountSelect');
  $dxcAccount.removeClass('select-green select-red');  
  const dxcAccountVal = $dxcAccount.val();
  if (dxcAccountVal === 'yes') {
    $dxcAccount.addClass('select-green');
  } else if (dxcAccountVal === 'no') {
    $dxcAccount.addClass('select-red');
  }

  // 2) DXC Embedded Account Select
  const $dxcEmbedded = $('#dxcEmbeddedAccountSelect');
  $dxcEmbedded.removeClass('select-green select-red');
  const dxcEmbeddedVal = $dxcEmbedded.val();
  if (dxcEmbeddedVal === 'yes') {
    $dxcEmbedded.addClass('select-green');
  } else if (dxcEmbeddedVal === 'no') {
    $dxcEmbedded.addClass('select-red');
  }
}




function loadFocusModalData() {
    db.tasks.where('stage').notEqual('Complete').toArray().then(tasks => {
        // Sort tasks by customerName, then by projectName, then by their 'order' field
        tasks.sort((a,b) => {
            const custCompare = a.customerName.localeCompare(b.customerName);
            if (custCompare !== 0) return custCompare;
            const projCompare = a.projectName.localeCompare(b.projectName);
            if (projCompare !== 0) return projCompare;
            return (a.order || 0) - (b.order || 0); // Sort by order as a tiebreak
        });

        const allTasks = tasks.filter(t => !t.focus);
        const focusTasks = tasks.filter(t => t.focus === true);

        // Clear current lists
        $('#allTasksList').find('.taskDivFocus').remove();
        $('#focusTasksList').find('.taskDivFocus').remove();

        // Render all tasks (not focus)
        allTasks.forEach(task => {
            const div = createFocusTaskDiv(task); 
            $('#allTasksList').append(div);
        });

        // Render focus tasks
        focusTasks.forEach(task => {
            const div = createFocusTaskDiv(task);
            $('#focusTasksList').append(div);
        });

        makeFocusListsSortable();
    });
}

function createFocusTaskDiv(task) {
    const custName = task.customerName || '';
    const projName = task.projectName || '';

    let taskText;

    if (custName === "Focus") {
        taskText = task.task; // Only show task if customer is "Focus"
    } else if (projName === "Task") {
        taskText = `<strong>${custName}</strong> - ${task.task}`; // Bold customer name, exclude project name if it's "Task"
    } else {
        taskText = `<strong>${custName}</strong> ${projName} - ${task.task}`; // Bold customer name, keep project name
    }

    let $div = $('<div>')
        .addClass('taskDivFocus')
        .attr('data-id', task.id)
        .attr('data-focus', task.focus)
        .html(taskText) // Use .html() instead of .text() to allow HTML formatting
        .click(function() {
            openEditTaskModal(task.id);
        });

    return $div;
}





function openEditTaskModal(taskId) {
    db.tasks.get(taskId).then(t => {
        $('#editTaskField').val(t.task);
        $('#editTaskComments').val(t.comments);
        $('#editTaskPriority').prop('checked', t.priority === 'High');
        taskMainCurrentSelectedId = t.id;
        $('#editTaskModal').modal('show');
    });
}

function makeFocusListsSortable() {
    // Both lists are sortable and connected
    $("#allTasksList, #focusTasksList").sortable({
        connectWith: "#allTasksList, #focusTasksList",
        items: ".taskDivFocus",
        placeholder: "sortable-placeholder",
        update: function(event, ui) {
            // Check if the item is now in focusTasksList
            if (this === ui.item.parent()[0]) {
                const taskId = parseInt(ui.item.attr('data-id'),10);
                let newFocus = (ui.item.parent().attr('id') === 'focusTasksList');
                
                // Update the focus field in the DB
                db.tasks.update(taskId, { focus: newFocus }).then(updated => {
                    if (updated) {
                        console.log(`Task ${taskId} focus updated to ${newFocus}`);
                    }
                });

                // If the update happened in the focusTasksList, save the order of all tasks in that list
                if (newFocus) {
                    $("#focusTasksList .taskDivFocus").each(function(index) {
                        var id = parseInt($(this).data('id'), 10);
                        db.tasks.update(id, { order: index }).catch(error => console.error(error));
                    });
                }
            }
        }
    }).disableSelection();
}


// Add event listener for search input
$('#taskSearchBox').on('input', function() {
    var searchValue = $(this).val().toLowerCase();

    // Hide or show tasks in allTasksList based on the search string
    $('#allTasksList .taskDivFocus').each(function() {
        var textContent = $(this).text().toLowerCase();
        if (textContent.includes(searchValue)) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
});


function applyStatusBackgroundHighlight(cell, statusText) {
  if (!statusText) {
    statusText = cell.find('select.status-select').val();
  }
  statusText = statusText.toLowerCase().trim();

  let highlightColor = 'transparent';
  if (statusText === 'cold') {
    highlightColor = '#add8e6'; // Light blue
  } else if (statusText === 'warm') {
    highlightColor = '#ffb347'; // Warm orange
  } else if (statusText === 'hot') {
    highlightColor = '#ff6961'; // Red
  }

  // Remove any old cell-level background so it stays transparent
  cell.css('background-color', 'transparent');

  // Apply the highlight directly to the <select>
  const $select = cell.find('select.status-select');
  $select.css({
    'background-color': highlightColor,
    'border-radius': '3px',
    'padding': '3px'
  });
}


// Handle changes on the status dropdown
$(document).on('change', '.status-select', function() {
    let selectElement = $(this);
    let newStatus = selectElement.val();
    let contactId = selectElement.closest('tr').data('id');

    // Update the database
    db.contacts.update(contactId, { status: newStatus }).then(function() {
        console.log(`Contact ${contactId} updated: status = ${newStatus}`);

        // Apply the new highlight to only the text inside the status cell
        let statusCell = selectElement.closest('.status-cell');
        applyStatusBackgroundHighlight(statusCell, newStatus);
    }).catch(function(error) {
        console.error('Failed to update contact status:', error);
    });
});



function loadAndDisplayContactsForSelectedCustomer() {
    const selectedCustomerId2A = parseInt($('#customerDropDown').val(), 10);
    console.log(selectedCustomerId2A)
    // Get contacts from the DB, sorted by order
    db.contacts
      .where({ customerId: selectedCustomerId2A })
      .toArray()
      .then(contacts => {
          // Sort contacts by order. If order is undefined, they end up at the bottom or top depending on sort logic.
          contacts.sort((a, b) => {
            // If either order is undefined, treat it as a large number or handle gracefully
            const orderA = (typeof a.order === 'number') ? a.order : Number.MAX_SAFE_INTEGER;
            const orderB = (typeof b.order === 'number') ? b.order : Number.MAX_SAFE_INTEGER;
            return orderA - orderB;
          });

          let tableRows = '';
          contacts.forEach(function(contact) {
              // Define status options
              const statusOptions = ['Select Status', 'Cold', 'Warm', 'Hot'];
              let statusOptionsHtml = '';
              statusOptions.forEach(function(statusOption) {
                  const selected = contact.status === statusOption ? 'selected' : '';
                  const disabled = statusOption === 'Select Status' ? 'disabled' : '';
                  statusOptionsHtml += `<option value="${statusOption}" ${selected} ${disabled}>${statusOption}</option>`;
              });

              tableRows += `
                  <tr data-id="${contact.id}">
                      <td class="contactTableName">${contact.name}</td>
					  <td class="editable-cell edit-contact" data-field="jobRole">${contact.jobRole || ''}</td>
                      <td class="editable-cell edit-contact" data-field="execMapping">${contact.execMapping || ''}</td>
                      <td class="status-cell">
                          <select class="form-control status-select" data-field="status">
                              ${statusOptionsHtml}
                          </select>
                      </td>
                      <td class="editable-cell  edit-contact" data-field="recentEvents">${contact.recentEvents || ''}</td>
                      <td class="editable-cell  edit-contact" data-field="plannedEvents">${contact.plannedEvents || ''}</td>
                  </tr>
              `;
          });
          $('#contactsTableBody').html(tableRows);

          // Apply background colors for the Status cells
$('#contactsTableBody .status-cell').each(function() {
  const selectedText = $(this).find('select option:selected').text().trim();
  applyStatusBackgroundHighlight($(this), selectedText);
});
      })
      .catch(error => {
          console.error("Failed to load contacts:", error);
      });
}



// Delay function to wait until typing stops
function delay(callback, ms) {
    let timer = 0;
    return function() {
        clearTimeout(timer);
        timer = setTimeout(callback, ms);
    };
}



// 7) In-line text editing (notes, nextSteps, accountName, contactName)
$(document).on('click', 'tr[data-store="newLogoContacts"] .editable-cell', function() {
	console.log("running inline update ")

    let cell = $(this);
    let originalText = cell.text().trim();
    let contactId = cell.closest('tr').data('id');
    let field = cell.data('field');

    let input = $('<textarea>').addClass('form-control').val(originalText);
    cell.html(input);
    input.focus();

    input.on('blur', function() {
        let newValue = $(this).val().trim();
        cell.text(newValue);

        // If field is notes or nextSteps, also auto-update lastInteraction to now:
        let updates = {[field]: newValue};
        if (field === 'notes' || field === 'nextSteps') {
            updates.lastInteraction = new Date().toISOString();
        }

        db.newLogoContacts.update(contactId, updates).then(() => {
            loadNewLogoAccounts();
        });
    });
});

// 8) Icons: left-click => Edit modal, right-click => copy to clipboard
$(document).on('contextmenu', '.fa-phone, .fa-envelope, .fab.fa-linkedin, [data-newlogoclick]', function(e) {
    e.preventDefault();
    const contactId = parseInt($(this).data('id'));
    const field = $(this).data('field');

    db.newLogoContacts.get(contactId).then(contact => {
        if (!contact) return;
        const textToCopy = contact[field] || '';
        if (!textToCopy) return;
        navigator.clipboard.writeText(textToCopy).then(() => {
           console.log(`[${field}] copied to clipboard: ${textToCopy}`);
        });
    });
	     // 2) Update lastInteraction to now
        db.newLogoContacts.update(contactId, { lastInteraction: new Date().toISOString() })
          .then(() => {
              loadNewLogoAccounts(); // re-sort table
          });
    return false; // prevent default context menu
});

$(document).on('click', '.fa-phone, .fa-envelope, .fab.fa-linkedin, td[data-newlogoclick="yes"]', function () {
  const contactId = parseInt($(this).data('id'));
  const validSectors = [
    "Technology",
    "Banking",
    "Insurance",
    "Financial Services",
    "Healthcare",
    "Retail",
    "Manufacturing",
    "Telecommunications",
    "Energy",
    "Construction",
    "Transport & Logistics",
    "Education",
    "Hospitality",
    "Media & Entertainment",
    "Public Sector",
    "Other",
  ];
  
   const validJobRoles = [
    "CEO",
    "CIO",
    "CFO",
    "IT Director / Head of IT",
    "Service Delivery Manager",
    "IT Operations",
    "Architect",
    "Digital Transformation Leader",
    "Procurement",
    "Platform Owner",
    "Product Owner",
    "Other",
  ];

  db.newLogoContacts.get(contactId).then((contact) => {
    if (!contact) return;

    // Set basic contact details
    $('#editNewLogoContactId').val(contact.id);
    $('#editPhoneInput').val(contact.phone || '');
    $('#editEmailInput').val(contact.email || '');
    $('#editLinkedInInput').val(contact.linkedin || '');
	 $('#editAccountNameInput').val(contact.accountName || '');


  // Check if the contact already has a job role and set it
    const $jobRoleSelect = $('#editJobRoleSelect');
    if (contact.jobRole && validJobRoles.includes(contact.jobRole)) {
      $jobRoleSelect.val(contact.jobRole);
    } else {
      $jobRoleSelect.val('');
    }

    // Build and populate the sector dropdown dynamically
    const $sectorDropdown = $('#editSectorInput2');
    $sectorDropdown.empty(); // Clear any existing options
    $sectorDropdown.append('<option value="">Select Sector</option>'); // Default placeholder

    validSectors.forEach((sector) => {
      $sectorDropdown.append(`<option value="${sector}">${sector}</option>`);
    });

    // Check if the contact already has a sector and set it
    if (contact.sector && validSectors.includes(contact.sector)) {
      $sectorDropdown.val(contact.sector);
    }

    // Show the modal
    $('#editNewLogoContactModal').modal('show');

    // Check account focus and update the checkbox
    $('#editAccountFocusCheckbox').prop('checked', !!contact.accountFocus);
  });
});



// 9) Save from the edit popup
$('#saveNewLogoContact').on('click', async function() {
    const contactId = parseInt($('#editNewLogoContactId').val());
    const newPhone = $('#editPhoneInput').val().trim();
	 const accountName = $('#editAccountNameInput').val().trim();
    const newEmail = $('#editEmailInput').val().trim();
    const newLinkedIn = $('#editLinkedInInput').val().trim();
    const newFocusValue = $('#editAccountFocusCheckbox').is(':checked'); // read the checkbox
// NEW: read the selected job role
    const newJobRole = $('#editJobRoleSelect').val();
	
    // First, get the contact to find its accountName
    const contact = await db.newLogoContacts.get(contactId);
    if (!contact) return;

    // Update the single contact’s fields
    await db.newLogoContacts.update(contactId, {
        accountName: accountName,
		phone: newPhone,
        email: newEmail,
        linkedin: newLinkedIn,
		 jobRole: newJobRole, 
        lastInteraction: new Date().toISOString() // always update lastInteraction
    });

    // Now mark the entire account with accountFocus = newFocusValue
    // For simplicity, we do .modify() on all matching rows
    await db.newLogoContacts
        .where('accountName')
        .equals(contact.accountName)
        .modify({ accountFocus: newFocusValue });

    // Close modal
    $('#editNewLogoContactModal').modal('hide');

    // Refresh whichever listing is on screen
    //  - Refresh accounts if we’re on the account list
    //  - If the user is looking at the contact table for that account, refresh that too
   // loadNewLogoAccounts();
    loadContactsForAccount(contact.accountName);
});

$(document).on('click', '#newLogoTableBody .editable-cell', function() {
  if ($(this).find('textarea').length > 0) {
        return;
    }
  const cell = $(this);
  const originalText = cell.text().trim();
  const field = cell.data('field'); // e.g. "notes" or "nextSteps"
  const contactId = cell.closest('tr').data('id');

  // Create a textarea with the original text
  const input = $('<textarea>')
    .addClass('form-control')
    .val(originalText);

  // Replace the cell’s content with this textarea
  cell.html(input);
  input.focus();
   autoGrow(input[0]);

  // A function to finalize editing:
  function saveCellChanges() {
    const newValue = input.val().trim();
    cell.text(newValue); // Replace with plain text
    db.newLogoContacts.update(contactId, {
      [field]: newValue,
      lastInteraction: new Date().toISOString() // optional
    }).then(() => {
      console.log(`Updated contact ${contactId}: ${field} = ${newValue}`);
    }).catch(err => console.error('Failed to update contact:', err));
  }

  // If the user simply clicks away, we save
  input.on('blur', function() {
    saveCellChanges();
  });

  // Listen for key presses
  input.on('keypress', function(e) {
    if (e.key === 'Enter' || e.keyCode === 13) {
      // Check if Shift, Ctrl, or Alt is also held down
      if (e.shiftKey || e.ctrlKey || e.altKey) {
        // Insert a newline at the cursor position
        e.preventDefault(); 
        const start = this.selectionStart;
        const end = this.selectionEnd;
        const text = $(this).val();

        // Insert a "\n" in the textarea
        const updatedText = text.substring(0, start) + '\n' + text.substring(end);
        $(this).val(updatedText);
		 autoGrow(this);

        // Move the cursor after the newline
        this.selectionStart = this.selectionEnd = start + 1;
      } else {
        // No modifier keys → user wants to "submit"
        e.preventDefault();
        saveCellChanges();
        // Optionally, remove focus so the blur event doesn't double-trigger
        input.blur();
      }
    }
  });
});

function autoGrow(textareaElement) {
  // Reset the height to let the browser recalc
  textareaElement.style.height = 'auto';
  // Set the height to the scroll height
  textareaElement.style.height = textareaElement.scrollHeight + 'px';
}





$(document).on('click', '.editable-cell.edit-contact', function() {
console.log("running 2660 function")
    let cell = $(this);
    let originalText = cell.html().trim();
	console.log(originalText)
    let contactId = cell.closest('tr').data('id');
    let field = cell.data('field');

    let input = $('<textarea>')
        .addClass('form-control')
        .val(originalText)
        .appendTo(cell)
        .focus();

    input.on('input', delay(function() {
        let newValue = input.val();

        // Update the database
        db.contacts.update(contactId, { [field]: newValue }).then(function() {
            console.log(`Contact ${contactId} updated: ${field} = ${newValue}`);

            // For Status field, update background color
            if (field === 'status') {
                const selectedText = $(this).find('select option:selected').text().trim();
  applyStatusBackgroundHighlight($(this), selectedText);
            }
        }).catch(function(error) {
            console.error('Failed to update contact:', error);
        });
    }, 500)); // Adjust the delay as needed

    input.on('blur', function() {
        cell.text(input.val());
    });
});


 // A helper to maintain table cell widths while dragging
  var fixHelperModified = function(e, tr) {
    var $originals = tr.children();
    var $helper = tr.clone();
    $helper.children().each(function(index) {
      // Set helper cell sizes to match the original cells
      $(this).width($originals.eq(index).width());
    });
    return $helper;
  };




//project notes

// Event listener for opening the project notes modal
$('#textEditorModalProject').on('shown.bs.modal', function () {
    loadProjectNotes(currentProjectId);
});

function loadProjectNotes(projectId) {
    // Retrieve project notes from the database
    db.projectnotes.where({ projectId: projectId }).first().then(function(note) {
        if (note) {
            // Populate the notes in the editor
            $('#textEditorProject').summernote('code', note.notes);
        } else {
            // No notes found, clear the editor or set a default message
            $('#textEditorProject').summernote('code', '');
        }
    }).catch(function(error) {
        console.error("Failed to load project notes:", error);
    });
}


$('#toggleNotesBtn').click(function() {
	$('#textEditorModalProject').modal('show'); // Show the modal
});


/*
$(document).on('click', '.editable-cell', function(event) {
// may not be neeed????? //
	console.log("running 3740")
    let cell = $(this);
    let originalText = cell.text();
    let contactId = cell.closest('tr').data('id');
    let field = cell.data('field');

    // Create the textarea
    let input = $('<textarea>')
        .addClass('form-control')
        .val(originalText)
        .appendTo(cell.empty())
        .focus();

    // Prevent click events inside the textarea from propagating to the cell
    input.on('click', function(event) {
        event.stopPropagation();
    });

    // Handle input event with delay
    input.on('input', delay(function() {
        let newValue = input.val();

        // Update the database
        db.contacts.update(contactId, { [field]: newValue }).then(function() {
            console.log(`Contact ${contactId} updated: ${field} = ${newValue}`);
        }).catch(function(error) {
            console.error('Failed to update contact:', error);
        });
    }, 500)); // Adjust the delay as needed

    // Handle blur event
    input.on('blur', function() {
        cell.text(input.val());
    });
});
*/



   function adjustTextAreaHeight(textArea) {
        // Reset the height to ensure accurate measurement
        textArea.css('height', 'auto');
        
        // Adjust the height based on the scroll height, up to 400px
        var scrollHeight = textArea[0].scrollHeight;
        var newHeight = scrollHeight > 400 ? 400 : scrollHeight;
        textArea.css('height', newHeight + 'px');
    }

    // Event listener for textarea input
    $('#editTaskComments').on('input', function() {
        adjustTextAreaHeight($(this));
    });

    // Event listener for modal shown
    $('#editTaskModal').on('shown.bs.modal', function () {
        adjustTextAreaHeight($('#editTaskComments'));
    });


// Declare a variable to hold the current contact's ID
let currentContactId = null;

// Event listener for clicking on the contact name cell
$(document).on('click', '.contactTableName', function() {
  // Get the contact's ID from the parent row's data-id attribute
  currentContactId = $(this).closest('tr').data('id');
  
  // Fetch the contact's data from IndexedDB
  db.contacts.get(currentContactId).then(function(contact) {
    if (contact) {
      // Populate the modal's fields with the contact's data
      $('#editContactName').val(contact.name);
      $('#editContactEmail').val(contact.email);
	       $('#editContactJobRole').val(contact.jobRole || ''); // Populate 'Job Role'
      $('#editContactPhone').val(contact.phone);
      $('#editContactLinkedIn').val(contact.linkedIn);
      
      // Show the modal
      $('#editContactModal').modal('show');
    } else {
      console.error('Contact not found:', currentContactId);
    }
  }).catch(function(error) {
    console.error('Failed to fetch contact:', error);
  });
});

// Event listener for 'Save Changes' button in the edit contact modal
$('#saveContactChangesButton').on('click', function() {
  // Get the updated values from the modal's fields
  let updatedName = $('#editContactName').val().trim();
  let updatedEmail = $('#editContactEmail').val().trim();
    let updatedJobRole = $('#editContactJobRole').val().trim(); // New field
  let updatedPhone = $('#editContactPhone').val().trim();
  let updatedLinkedIn = $('#editContactLinkedIn').val().trim();
  
  // Update the contact in IndexedDB
  db.contacts.update(currentContactId, {
    name: updatedName,
	 jobRole: updatedJobRole, // Include the job role
    email: updatedEmail,
    phone: updatedPhone,
    linkedIn: updatedLinkedIn
  }).then(function(updated) {
    if (updated) {
      console.log('Contact updated:', currentContactId);
      // Close the modal
      $('#editContactModal').modal('hide');
      // Refresh the contacts table
      loadAndDisplayContactsForSelectedCustomer();
    } else {
      console.error('Failed to update contact:', currentContactId);
    }
  }).catch(function(error) {
    console.error('Failed to update contact:', error);
  });
});

// Event listener for 'Delete' button in the edit contact modal
$('#deleteContactButton').on('click', function() {
  // Confirm deletion
  if (confirm('Are you sure you want to delete this contact?')) {
    // Delete the contact from IndexedDB
    db.contacts.delete(currentContactId).then(function() {
      console.log('Contact deleted:', currentContactId);
      // Close the modal
      $('#editContactModal').modal('hide');
      // Refresh the contacts table
      loadAndDisplayContactsForSelectedCustomer();
    }).catch(function(error) {
      console.error('Failed to delete contact:', error);
    });
  }
});





// Event listener for Delete button in editNewLogoContactModal
$('#deleteNewLogoContact').on('click', function() {
    // Grab the contact ID from the hidden input
    const contactId = parseInt($('#editNewLogoContactId').val(), 10);
    if (!contactId) {
      console.warn("No contact ID found, cannot delete.");
      return;
    }

    // Optional: Confirm the deletion
    if (!confirm('Are you sure you want to delete this contact?')) {
      return;
    }

    // Delete from IndexedDB (table: newLogoContacts)
    db.newLogoContacts.delete(contactId)
      .then(() => {
        console.log(`Contact with id=${contactId} deleted from newLogoContacts`);
        // Reload the table to remove the deleted contact from UI
        loadNewLogoAccounts();
        // Hide the modal
        $('#editNewLogoContactModal').modal('hide');
      })
      .catch(error => {
        console.error("Failed to delete new logo contact:", error);
      });
});







async function loadMindMap() {
  try {
    // Attempt to load the mind map record with the current customerId.
    const record = await db.MindMapData
      .where('customerId')
      .equals(currentCustomerId)
      .first();

    let initialData;
    if (record && record.data) {
      console.log("Existing mind map found for customer:", currentCustomerId);
      initialData = record.data;
    } else {
      console.log("No existing mind map found. Creating a new topic.");
      initialData = MindElixir.new('New Topic');
    }
    
    initializeMindMap(initialData);
  } catch (error) {
    console.error("Error loading mind map data:", error);
  }
}

let mind;


function initializeMindMap(initialData) {
    mind = new MindElixir({
    el: '#mindmapDiv',
    direction: MindElixir.LEFT,
    draggable: true,
    contextMenu: true,
    toolBar: true,
    nodeMenu: true,
    keypress: true,
    // Callback for any changes in the mind map
    onchange: function(data) {
	console.log("Mind map changed", data);
      //saveMindMapData(data);
    }
  }); 
  // Initialise with loaded or default data
  mind.init(initialData);
  console.log("Mind map initialised:", mind);
  
}


 // Optionally, if needed, add additional event listeners
  const mindMapDiv = document.querySelector('#mindmapDiv');
  if (mindMapDiv) {
    mindMapDiv.addEventListener('keyup', function() {
      const data = mind.getAllData();
console.log(data)	  
      saveMindMapData(data);
    });
  }



async function saveMindMapData(data) {
  console.log('Saving mind map data');
  try {
    // Check if there is an existing record with the current customer number.
    const existingRecord = await db.MindMapData
      .where('customerId')
      .equals(currentCustomerId)
      .first();

    if (existingRecord) {
      // Update the existing record
      await db.MindMapData.update(existingRecord.id, { 
        data: data, 
        modified: new Date() 
      });
      console.log("Mind map data updated successfully.");
    } else {
      // Add a new record if one doesn't exist for the customer.
      await db.MindMapData.add({ 
        customerId: currentCustomerId, 
        data: data, 
        modified: new Date() 
      });
      console.log("Mind map data added successfully.");
    }
  } catch (error) {
    console.error("Error saving mind map data:", error);
  }
}

























// Export all data to JSON and download
$('#backupDataButton').click(function() {
    exportDatabaseToJsonAndDownload(db);
});

// Open the Import New Logos Modal
$('#importNewLogosButton').click(function() {
    $('#newLogosJsonInput').val(''); // Clear textarea
    $('#importNewLogosModal').modal('show');
});

// Confirm Import
$('#importNewLogosConfirmButton').click(async function() {
    let jsonText = $('#newLogosJsonInput').val().trim();
    if(!jsonText) {
        alert("Please paste the JSON data first.");
        return;
    }

    let dataArray;
    try {
        dataArray = JSON.parse(jsonText);
        if(!Array.isArray(dataArray)) {
            alert("JSON must be an array of objects.");
            return;
        }
    } catch (e) {
        alert("Invalid JSON format.");
        return;
    }

    // Fields in newLogoContacts
    const fields = ["accountName","contactName","sector","stage","jobRole","lastInteraction","notes","nextSteps","phone","email","linkedin"];

    // Insert each object into newLogoContacts, defaulting unknown fields to ''
    try {
        await db.transaction('rw', db.newLogoContacts, async() => {
            for (const obj of dataArray) {
                let record = {};
                fields.forEach(f => {
                    record[f] = obj.hasOwnProperty(f) ? obj[f] : '';
                });
                // If lastInteraction is provided and not empty, convert to ISO if possible
                if (record.lastInteraction) {
                    let dateCheck = new Date(record.lastInteraction);
                    if (!isNaN(dateCheck)) {
                        record.lastInteraction = dateCheck.toISOString();
                    } else {
                        // If not a valid date, set to empty
                        record.lastInteraction = '';
                    }
                }
                await db.newLogoContacts.add(record);
            }
        });
        alert("Import completed successfully!");
        $('#importNewLogosModal').modal('hide');
        // Reload table if currently viewing newLogoModal
        if ($('#newLogoModal').hasClass('show')) {
            loadNewLogoAccounts();
        }
    } catch (error) {
        console.error("Failed to import new logos:", error);
        alert("Failed to import. Check console for details.");
    }
});



$(document).ready(function () {
  const validSectors = [
    "Technology",
    "Banking",
    "Insurance",
    "Financial Services",
    "Healthcare",
    "Retail",
    "Manufacturing",
    "Telecommunications",
    "Energy",
    "Construction",
    "Transport & Logistics",
    "Education",
    "Hospitality",
    "Media & Entertainment",
    "Public Sector",
    "Other",
  ];

  // Listen for input changes in the newLogoAccountInput field
  $("#newLogoAccountInput").on("input", async function () {
    const accountName = $(this).val().trim();

    if (accountName !== "") {
      try {
        // Search for a matching account in newLogoContacts
        const match = await db.newLogoContacts
          .where("accountName")
          .equalsIgnoreCase(accountName)
          .first();

        if (match && validSectors.includes(match.sector)) {
          // If a match is found and the sector is valid, update the dropdown
          $("#newLogoSectorInput").val(match.sector);
        } else {
          // If no match or sector is invalid, reset the dropdown
          $("#newLogoSectorInput").val("");
        }
      } catch (error) {
        console.error("Error accessing the database:", error);
      }
    } else {
      // If input is cleared, reset the dropdown
      $("#newLogoSectorInput").val("");
    }
  });
});

























 // Populate the dropdown at page load
    loadCustomersIntoDropdown();





//export 
//exportDatabaseToJsonAndDownload(db)
async function exportDatabaseToJsonAndDownload(db) {
    try {
        const dbData = {};
        const tableNames = db.tables.map(table => table.name);

        for (const tableName of tableNames) {
            dbData[tableName] = await db.table(tableName).toArray();
        }

        const jsonStr = JSON.stringify(dbData, null, 2); // Pretty print the JSON
        const blob = new Blob([jsonStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);

        // Create a link and set the URL as the href
        const a = document.createElement("a");
        a.href = url;
        a.download = "database_export.json"; // Name of the file to download
        document.body.appendChild(a); // Append the link to the body
        a.click(); // Simulate a click on the link to start download
        document.body.removeChild(a); // Remove the link from the body
        URL.revokeObjectURL(url); // Clean up by revoking the blob URL

    } catch (error) {
        console.error("Failed to export database:", error);
    }
}







// Start checking backups on a 4-hour interval
    startBackupTimer()
	
function startBackupTimer() {
    const FOUR_HOURS_MS = 4 * 60 * 60 * 1000;

    // Immediately run one check now (optional):
    checkAutoBackup();

    // Then run again every 4 hours
    setInterval(() => {
        checkAutoBackup();
    }, FOUR_HOURS_MS);
}

function checkAutoBackup() {
    const ONE_DAY_MS = 24 * 60 * 60 * 1000;
    const SEVEN_DAYS_MS = 7 * ONE_DAY_MS;
    const now = Date.now();

    // We'll store the 'lastBackupDate' in a fixed record with id=1
    const BACKUP_DOC_ID = 1;

    db.backupInfo.get(BACKUP_DOC_ID).then(record => {
        if (!record) {
            // No record found, so we do a backup right now
            console.log("No backupInfo record found. Exporting all data now...");
            exportAllDataFromDexie();
            return;
        }

        // Otherwise, compare how old the last backup is
        const lastBackupTime = new Date(record.lastBackupDate).getTime();
        const timeDiff = now - lastBackupTime;

        if (timeDiff > SEVEN_DAYS_MS) {
            console.log("More than 7 days since last backup. Auto-export triggered...");
            exportAllDataFromDexie();
        } else {
            console.log("Last backup was recent; no auto-export needed at this time.");
        }
    }).catch(err => {
        console.error("Failed to check or update backupInfo:", err);
    });
}

function exportAllDataFromDexie() {
    // The same function you already have (or used to have) for exporting:
    exportDatabaseToJsonAndDownload(db)
        .then(() => {
            // After successful export, update the lastBackupDate
            const BACKUP_DOC_ID = 1;
            return db.backupInfo.put({
                id: BACKUP_DOC_ID, 
                lastBackupDate: new Date().toISOString()
            });
        })
        .then(() => {
            console.log("Export completed and lastBackupDate updated.");
        })
        .catch(error => {
            console.error("Failed to export or update backup date:", error);
        });
}





//white space 

const defaultAppStatus = {
  "modules": [
    {
      "module": "IT Service Management (ITSM)",
      "applications": [
        {
          "application": "Incident Management",
          "description": "Logging and resolving IT incidents to restore normal service operations quickly.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Problem Management",
          "description": "Identifying root causes of recurring incidents and driving permanent solutions.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Change Management",
          "description": "Planning and controlling the lifecycle of IT changes to minimise risk and disruption.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Service Request Management & Catalog",
          "description": "Handling user requests for services or equipment through a service catalog and automated workflows.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Knowledge Management",
          "description": "Creating and maintaining a knowledge base for technicians and end-users to find solutions faster.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Virtual Agent",
          "description": "An AI-powered chatbot providing 24/7 automated assistance for common IT tasks.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Predictive Intelligence",
          "description": "Machine learning features that automatically categorise and route tickets, suggest solutions, and detect similarities.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Service Level Management",
          "description": "Tracking and enforcing SLAs, often integrated with Incident and Request Management.",
          "status": "",
          "notes": ""
        },
        {
          "application": "CMDB Integration",
          "description": "Utilising the Configuration Management Database to support ITSM processes by maintaining up-to-date asset and service relationships.",
          "status": "",
          "notes": ""
        }
      ]
    },
    {
      "module": "IT Operations Management (ITOM)",
      "applications": [
        {
          "application": "Discovery",
          "description": "Automatically scanning the network to identify hardware, software, and cloud resources and updating the CMDB.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Service Mapping",
          "description": "Mapping applications to their underlying infrastructure components and showing relationships and dependencies.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Event Management",
          "description": "Consolidating and correlating alerts from monitoring tools to detect issues and create incidents.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Cloud Provisioning and Management",
          "description": "Managing cloud infrastructure provisioning, orchestration, and cost visibility.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Orchestration",
          "description": "Automating routine IT tasks and remote actions across systems and applications.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Operational Intelligence (AIOps)",
          "description": "Using machine learning to analyse metrics and logs, detect anomalies, and predict performance issues.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Alert or Incident Correlation",
          "description": "Focusing on alert management or anomaly detection more distinctly when implemented separately.",
          "status": "",
          "notes": ""
        }
      ]
    },
    {
      "module": "IT Asset Management (ITAM)",
      "applications": [
        {
          "application": "Hardware Asset Management",
          "description": "Tracking physical assets end-to-end including acquisition, inventory, maintenance, and disposal.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Software Asset Management",
          "description": "Managing software licenses and usage to ensure compliance and optimise costs.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Cloud Asset Management",
          "description": "Monitoring usage and spend of cloud resources and managing SaaS subscriptions.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Asset Lifecycle & Inventory",
          "description": "Centralised asset repository with lifecycle workflows and inventory management.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Contract & Vendor Management",
          "description": "Tracking asset-related contracts and vendor information to manage renewals and ensure compliance.",
          "status": "",
          "notes": ""
        },
        {
          "application": "License Compliance Tracking",
          "description": "Automated tracking of software entitlements versus deployments to identify compliance gaps.",
          "status": "",
          "notes": ""
        }
      ]
    },
    {
      "module": "Strategic Portfolio Management (SPM)",
      "applications": [
        {
          "application": "Ideation / Idea Portal",
          "description": "A portal to capture raw innovation input from employees, customers, or stakeholders before formal demand management.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Demand Management",
          "description": "Capturing and evaluating incoming business ideas, project proposals, or strategic requests, assessing value, cost, and risk.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Project and Portfolio Management (PPM)",
          "description": "Planning and managing projects and programmes with visibility into timelines, resources, costs, and risks.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Resource Management",
          "description": "Allocating and tracking resources across projects to optimise utilisation.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Agile Development",
          "description": "Supporting agile development with backlog management, sprint planning, and tracking integrated with DevOps tools.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Application Portfolio Management (APM)",
          "description": "Inventorying and assessing business applications to rationalise the application landscape.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Financial Management",
          "description": "Tracking project/program costs and budgets, forecasting ROI, and managing expense tracking and benefit realisation.",
          "status": "",
          "notes": ""
        }
      ]
    },
    {
      "module": "Customer Service Management (CSM)",
      "applications": [
        {
          "application": "Case Management",
          "description": "Managing customer inquiries and issues from initial contact to resolution.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Omni-Channel Support",
          "description": "Supporting customers across multiple channels, feeding all interactions into a unified case system.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Self-Service Portal & Knowledge",
          "description": "Providing a customer portal for accessing knowledge articles, submitting issues, and requesting services.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Virtual Agent",
          "description": "An AI-driven chatbot assisting customers 24/7 with common requests or FAQs.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Entitlement Management",
          "description": "Managing customer contracts, SLAs, and product entitlements to ensure proper support levels.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Field Service Integration",
          "description": "Integrating with Field Service Management to dispatch technicians and link customer cases with field work orders.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Community and Escalation Management",
          "description": "Dedicated community portals and escalation workflows for handling complex cases.",
          "status": "",
          "notes": ""
        }
      ]
    },
    {
      "module": "Field Service Management (FSM)",
      "applications": [
        {
          "application": "Work Order & Task Management",
          "description": "Creating and tracking work orders and tasks for field service jobs from assignment to completion.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Scheduling and Dispatch",
          "description": "Using a dispatch console and scheduling engine to assign the right technician based on skills and location.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Field Mobile App",
          "description": "A mobile application for technicians to view tasks, get directions, update statuses, and work offline.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Asset and Inventory Management",
          "description": "Providing visibility into customer assets at the service location and tracking spare parts inventory.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Service Contract & Entitlement",
          "description": "Ensuring field work is covered under the correct contract or warranty, distinguishing billable work from warranty service.",
          "status": "",
          "notes": ""
        }
      ]
    },
    {
      "module": "HR Service Delivery (HRSD)",
      "applications": [
        {
          "application": "Employee Self-Service Portal",
          "description": "A one-stop HR portal for accessing HR knowledge, submitting requests, and tracking HR cases.",
          "status": "",
          "notes": ""
        },
        {
          "application": "HR Case & Knowledge Management",
          "description": "Managing employee inquiries and issues through workflow-based case management and a knowledge base.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Onboarding and Offboarding (Lifecycle Events)",
          "description": "Automating cross-department processes for onboarding new employees and offboarding departing ones.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Document Management",
          "description": "A secure repository for employee documents with electronic signature support and automated document generation.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Benefits Administration",
          "description": "Handling employee benefit requests and integrating with external benefits systems.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Time-Off and Leave Management",
          "description": "Enabling employees to request time off or leave, with requests routed for manager approval.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Performance Management",
          "description": "Tracking and managing performance review cycles, goals, and evaluations with integration options for talent management.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Dedicated HR Service Portal",
          "description": "An enhanced, user-friendly portal tailored to modernise the employee HR experience.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Employee Engagement and Surveys",
          "description": "Tools for gathering continuous employee feedback through surveys or pulse checks.",
          "status": "",
          "notes": ""
        }
      ]
    },
    {
      "module": "Workplace Service Delivery (WSD)",
      "applications": [
        {
          "application": "Reservation Management",
          "description": "Enabling employees to reserve workspaces such as conference rooms, desks, parking spots, or equipment.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Workplace Case Management",
          "description": "Allowing employees to report workplace issues or request services, with requests tracked as cases and routed for resolution.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Visitor Management",
          "description": "A digital system to register and manage office visitors, including pre-registration and check-in processes.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Space Management & Indoor Mapping",
          "description": "Tools for tracking space utilisation and occupancy, optimising floor layouts with indoor maps.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Maintenance Management",
          "description": "Scheduling and tracking preventive maintenance for workplace assets and facilities equipment.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Workplace Inventory & Supplies",
          "description": "Managing office supply inventory and automating requests for items through the portal.",
          "status": "",
          "notes": ""
        }
      ]
    },
    {
      "module": "Security Operations (SecOps)",
      "applications": [
        {
          "application": "Security Incident Response",
          "description": "A dedicated process for logging, investigating, and responding to security incidents.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Vulnerability Response",
          "description": "Managing vulnerability scan findings, prioritising risks, and tracking remediation efforts.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Threat Intelligence",
          "description": "Ingesting threat intelligence feeds and correlating them with internal incidents to enrich context.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Security Orchestration & Automation",
          "description": "Automating security response workflows and integrating with various security tools for containment and remediation.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Dashboards & Reporting",
          "description": "Providing real-time security dashboards and reports tracking incident response times, vulnerabilities, and compliance.",
          "status": "",
          "notes": ""
        }
      ]
    },
    {
      "module": "DevOps",
      "applications": [
        {
          "application": "CI/CD Pipeline Integration",
          "description": "Integrating with tools like GitHub, GitLab, Jenkins, etc., to track code commits, builds, tests, and deployments.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Change Management Integration",
          "description": "Automating the creation and approval of change records for production deployments based on pipeline events.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Planning and Tracking",
          "description": "Linking agile work items to code changes and deployments for end-to-end traceability.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Release Automation",
          "description": "Orchestrating complex release processes, triggering automated tests, and enabling rollback if needed.",
          "status": "",
          "notes": ""
        },
        {
          "application": "DevOps Dashboards",
          "description": "Monitoring key DevOps metrics such as deployment frequency and lead time for changes.",
          "status": "",
          "notes": ""
        }
      ]
    },
    {
      "module": "Now Platform App Engine and Automation",
      "applications": [
        {
          "application": "App Engine Studio",
          "description": "A guided development studio for building custom applications with drag-and-drop simplicity.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Flow Designer",
          "description": "A no-code workflow designer for visually automating multi-step processes.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Integration Hub",
          "description": "Providing pre-built connectors (spokes) and APIs for integrating with external systems and services.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Robotic Process Automation (RPA) Hub",
          "description": "Automating tasks in legacy applications or websites through software robots that mimic user actions.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Analytics and AI Services",
          "description": "Leveraging built-in analytics and AI capabilities, such as Performance Analytics and Machine Learning, in custom applications.",
          "status": "",
          "notes": ""
        },
        {
          "application": "Enterprise-grade Platform",
          "description": "Inheriting core features like role-based security, mobile accessibility, auditing, and scalability from ServiceNow.",
          "status": "",
          "notes": ""
        }
      ]
    }
  ]
}
 
 
 
 
 
 
// Global variable to hold the current application status data for the customer.
let appStatusData = null;

// Helper: Return a pastel background color based on status.
function getPastelColor(status) {
  switch(status.toLowerCase()) {
    case "red":
      return "#f4cccc"; // pastel red
    case "amber":
      return "#ffe599"; // pastel amber
    case "green":
      return "#b6d7a8"; // pastel green
    default:
      return "#ffffff"; // white (or no status)
  }
}


// ***** Render the Modal Content *****
// This function empties the #modulesContainer and then creates a row for each module,
// listing its title in bold and a box for each application.
function renderAppStatus(data) {
  const container = $("#modulesContainer");
  container.empty();

  data.modules.forEach((moduleItem, moduleIndex) => {
    // Create a module row with bold title.
    const moduleRow = $(`
      <div class="module-row" style="margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
        <div class="module-title" style="font-weight: bold; margin-bottom: 5px; font-size: 1.1em;">
          ${moduleItem.module}
        </div>
        <div class="apps-container" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
      </div>
    `);

    // For each application, create a clickable box.
    moduleItem.applications.forEach((appItem, appIndex) => {
      const appBox = $(`
        <div class="app-box" 
             data-module-index="${moduleIndex}" 
             data-app-index="${appIndex}" 
             title="${appItem.description}"
             style="padding: 10px; border: 1px solid #ccc; cursor: pointer; background-color: ${getPastelColor(appItem.status)}; min-width: 150px; text-align: center;">
          ${appItem.application}
        </div>
      `);

      // Left-click: Toggle a dropdown to select a new status.
      appBox.on("click", function() {
        // If a dropdown is already present, do nothing.
        if ($(this).find("select").length === 0) {
          // Create a select element with status options.
          const statusSelect = $(`
            <select class="form-control status-select" style="margin-top: 5px; font-size: 0.9em; color:black;">
              <option value="">Select Status</option>
              <option value="white">White</option>
              <option value="red">Red</option>
              <option value="amber">Amber</option>
              <option value="green">Green</option>
            </select>
          `);
          // Set current status.
          statusSelect.val(appItem.status);
          // When the value changes, update the JSON and box background.
          statusSelect.on("change", function() {
            const newStatus = $(this).val();
            appItem.status = newStatus;
            appBox.css("background-color", getPastelColor(newStatus));
            // Remove the dropdown after selection.
            $(this).remove();
			// Trigger the function on the saveAppStatus button.
$('#saveAppStatus').trigger('click');

// Wait 100ms, then hide the appStatusModal modal.
setTimeout(function() {
  $('#appStatusModal').modal('hide');

  // Wait another 100ms, then trigger the openAppStatusButton.
  setTimeout(function() {
    $('#openAppStatusButton').trigger('click');
  }, 100);
}, 300);
          });
          // Append the dropdown to the box.
          $(this).append(statusSelect);
        }
      });

// Right-click: Open a textarea to edit notes.
appBox.on("contextmenu", function(e) {
  e.preventDefault();

  // Create a textarea with the existing notes.
  const textArea = $('<textarea/>')
    .val(appItem.notes)
    .css({
      width: '100%',
      height: '100px',
      'box-sizing': 'border-box'
    });

  // Create a save button.
  const saveButton = $('<button/>').text('Save');

  // Clear the box and add the textarea and save button.
  appBox.empty().append(textArea, saveButton);
  textArea.focus();

  // Save notes when the button is clicked.
  saveButton.on('click', function() {
    // Save the updated notes, which include any new lines.
    appItem.notes = textArea.val();

    // Optionally update the border color.
    appBox.css("border-color", appItem.notes.trim() ? "#007bff" : "#ccc");

    // Replace the textarea with a simple text display.
    appBox.html(appItem.notes);
	
	// Trigger the function on the saveAppStatus button.
$('#saveAppStatus').trigger('click');

// Wait 100ms, then hide the appStatusModal modal.
setTimeout(function() {
  $('#appStatusModal').modal('hide');

  // Wait another 100ms, then trigger the openAppStatusButton.
  setTimeout(function() {
    $('#openAppStatusButton').trigger('click');
  }, 100);
}, 300);

	
	
	
  });
});



      // Append the application box to the module row.
      moduleRow.find(".apps-container").append(appBox);
    });

    container.append(moduleRow);
  });
}


// ***** Loading and Saving the JSON from/to Dexie *****
// Function to load the app status record for a given customerId.
// If not found, use the default and then store it.
function loadAppStatusData(customerId) {
  return db.appStatus.where("customerId").equals(customerId).first().then(record => {
    if (record && record.data) {
      return record.data;
    } else {
      // If not found, return a copy of the default structure.
      return JSON.parse(JSON.stringify(defaultAppStatus));
    }
  });
}

// Function to save the appStatusData for a given customerId.
function saveAppStatusData(customerId, data) {
  // Try to update an existing record; if not, add a new one.
  return db.appStatus.where("customerId").equals(customerId).first().then(record => {
    if (record) {
      return db.appStatus.update(record.id, { data: data });
    } else {
      return db.appStatus.add({ customerId: customerId, data: data });
    }
  });
}


// Function to load data from Dexie, render the modal, and show it.
function loadAndRenderAppStatusModal() {
	console.log("load data")
  loadAppStatusData(currentCustomerId).then(data => {
    appStatusData = data; // store in global variable
    renderAppStatus(appStatusData);
    $("#appStatusModal").modal("show");
  }).catch(err => {
    console.error("Error loading app status data:", err);
  });
}

// Save button handler.
$("#saveAppStatus").on("click", function() {
  saveAppStatusData(currentCustomerId, appStatusData).then(() => {
   // alert("Application status saved successfully!");
    $("#appStatusModal").modal("hide");
  }).catch(err => {
    console.error("Error saving app status data:", err);
   // alert("Error saving data. Check console for details.");
  });
});

// Optional: attach a trigger to open the modal.
$("#openAppStatusButton").on("click", function() {
	console.log("clicked")
	$('#textEditorModal').modal('hide');

  loadAndRenderAppStatusModal();
});














$(document).on('click', '#exportMind', async function() {
  // Get the DOM element containing the mind map
  const mindMapElement = document.getElementById('mindmapDiv');

  // Use html2canvas to render the element as a canvas
  html2canvas(mindMapElement).then((canvas) => {
    // Convert the canvas content to a data URL in PNG format
    const imageData = canvas.toDataURL('image/png');
    
    // Create a temporary download link
    const downloadLink = document.createElement('a');
    downloadLink.href = imageData;
    downloadLink.download = 'mindmap.png';
    
    // Append the link to the body (required for Firefox)
    document.body.appendChild(downloadLink);
    
    // Trigger the download
    downloadLink.click();
    
    // Clean up by removing the link
    document.body.removeChild(downloadLink);
  }).catch((error) => {
    console.error('Error exporting mind map to PNG:', error);
  });
})



$(".project-column").sortable({
  connectWith: ".project-column",
  placeholder: "sortable-placeholder",
  update: function(event, ui) {
    // Determine the new stage based on the id of the parent container
    var parentId = ui.item.parent().attr("id");
    var newStage = "";
    switch (parentId) {
      case "projectIdeas":
        newStage = "idea";
        break;
      case "projectDiscuss":
        newStage = "discuss";
        break;
      case "projectProposals":
        newStage = "proposal";
        break;
      case "projectFeedback":
        newStage = "feedback";
        break;
      case "projectClosed":
        newStage = "won";
        break;
      default:
        newStage = "idea";
    }

    // Retrieve the project id stored in the data attribute of the card
    var projectId = ui.item.data("projectid");

    // Update the project stage in your IndexedDB using Dexie
    db.projects.update(projectId, { stage: newStage })
      .then(() => {
        console.log("Project " + projectId + " updated to stage: " + newStage);
      })
      .catch(error => {
        console.error("Failed to update project stage:", error);
      });
  }
}).disableSelection();











});
</script>


</body>
</html>
